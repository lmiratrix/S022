<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Luke Miratrix">

<title>51&nbsp; An overview of complex error structures – Resources for S043/Stat151: Multilevel and Longitudinal Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./cluster_demo.html" rel="next">
<link href="./cov_matrix_derivation.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./icc_derivation.html">MATH DERIVATIONS</a></li><li class="breadcrumb-item"><a href="./complex_error.html"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">An overview of complex error structures</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Resources for S043/Stat151: Multilevel and Longitudinal Models</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./self_assess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Do I take S-043? A self-assessment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started with R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assignment_guidelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment Formatting Guidelines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./self_grading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self Grading Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">R &amp; R MARKDOWN</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./style_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">An R Code Style Guide (Miratrix version)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_markdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intro to R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./configuring_code_chunks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Configuring Rmarkdown chunks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intro to Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summarizing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Summarizing and exploring data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./making_tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Making tables in Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reg_table_demo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Making Regression and ANOVA Tables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diagnostic_plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Regression diagnostic plots for MLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./math_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">A Math Reference: Sample Modeling Equations to Borrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pivot_wider.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title"><code>pivot_longer</code> and <code>pivot_wider</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_missing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">An Introduction to Missing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_tips.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Tips, Tricks, and Debugging in R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">USING ggPLOT</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Intro to <code>ggplot</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./plot_expand_grid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Example of making plots with <code>expand.grid</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ggeffects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Easy viz for multilevel models with <code>ggeffects</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coefficient_plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Coefficient Plots</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./double_plot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Plotting Two Datasets at Once</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">MODEL FITTING &amp; INTERPRETATION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examining_shrinkage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">How Empirical Bayes over-shrinks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./broom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Extracting information from fitted <code>lmer</code> models with <code>broom</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lmer_extract.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extrating information from fitted <code>lmer</code> models using base R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpreting_coefficients.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Interpreting Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./within_v_between.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Within, Between, and Contextual Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual_tour_of_nulls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">A visual guide to parameters</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reg_assumptions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">MLM Assumptions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_representations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Model Representations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_cheat_sheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Connecting the three dots: An HSB Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./growth_models_predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Predictors in Longitudinal Growth Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpreting_glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Interpreting GLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lr_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Likelihood Ratio Tests</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aic_check.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">AIC, BIC, and Deviance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lmer_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Optimization Algorithms for MLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Bootstrapping clustered data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survey_weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Survey Weights</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">A flexible longitudinal model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">FIXED EFFECTS and FRIENDS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pooling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Pooling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fixed_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Clarification on Fixed Effects and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fe_crve.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">A tour of fixed effects and cluster-robust SEs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robust_mlm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">MLM and Cluster-Robust Standard Errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">WORKED EXAMPLES</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hsb_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Code for HSB Example in Chapter 4 of R&amp;B</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./faraway_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Code for Faraway Example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./perf_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Example of a three-level model of clustered data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kenya_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Example of a three-level longitudinal model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">VISUALIZATIONS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./icc_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">ICC Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rand_slopes_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Random Slopes Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rewb_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Within vs Between / Contextual Effects Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./centering_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Centering Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./latent_logit_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Latent Logit/LPM Visualization</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">MATH DERIVATIONS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./icc_derivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">ICC Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inflated_variance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Inflated Variance Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cov_matrix_derivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Covariance Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./complex_error.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">An overview of complex error structures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cluster_demo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Walk-through of calculating robust standard errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#national-youth-survey-running-example" id="toc-national-youth-survey-running-example" class="nav-link active" data-scroll-target="#national-youth-survey-running-example"><span class="header-section-number">51.1</span> National Youth Survey running example</a>
  <ul class="collapse">
  <li><a href="#getting-the-data-ready" id="toc-getting-the-data-ready" class="nav-link" data-scroll-target="#getting-the-data-ready"><span class="header-section-number">51.1.1</span> Getting the data ready</a></li>
  </ul></li>
  <li><a href="#representation-of-error-structure" id="toc-representation-of-error-structure" class="nav-link" data-scroll-target="#representation-of-error-structure"><span class="header-section-number">51.2</span> Representation of error structure</a></li>
  <li><a href="#reproducing-rbs-chapter-6-examples" id="toc-reproducing-rbs-chapter-6-examples" class="nav-link" data-scroll-target="#reproducing-rbs-chapter-6-examples"><span class="header-section-number">51.3</span> Reproducing R&amp;B’s Chapter 6 examples</a>
  <ul class="collapse">
  <li><a href="#compound-symmetry-random-intercept-model" id="toc-compound-symmetry-random-intercept-model" class="nav-link" data-scroll-target="#compound-symmetry-random-intercept-model"><span class="header-section-number">51.3.1</span> Compound symmetry (random intercept model)</a></li>
  <li><a href="#autoregressive-error-structure-ar1" id="toc-autoregressive-error-structure-ar1" class="nav-link" data-scroll-target="#autoregressive-error-structure-ar1"><span class="header-section-number">51.3.2</span> Autoregressive error structure (AR[1])</a></li>
  <li><a href="#random-slopes" id="toc-random-slopes" class="nav-link" data-scroll-target="#random-slopes"><span class="header-section-number">51.3.3</span> Random slopes</a></li>
  <li><a href="#random-slopes-with-heteroskedasticity" id="toc-random-slopes-with-heteroskedasticity" class="nav-link" data-scroll-target="#random-slopes-with-heteroskedasticity"><span class="header-section-number">51.3.4</span> Random slopes with heteroskedasticity</a></li>
  <li><a href="#fully-unrestricted-model" id="toc-fully-unrestricted-model" class="nav-link" data-scroll-target="#fully-unrestricted-model"><span class="header-section-number">51.3.5</span> Fully unrestricted model</a></li>
  </ul></li>
  <li><a href="#having-both-ar1-and-random-slopes" id="toc-having-both-ar1-and-random-slopes" class="nav-link" data-scroll-target="#having-both-ar1-and-random-slopes"><span class="header-section-number">51.4</span> Having both AR[1] and Random Slopes</a></li>
  <li><a href="#the-kitchen-sink-building-complex-models" id="toc-the-kitchen-sink-building-complex-models" class="nav-link" data-scroll-target="#the-kitchen-sink-building-complex-models"><span class="header-section-number">51.5</span> The Kitchen sink: building complex models</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./icc_derivation.html">MATH DERIVATIONS</a></li><li class="breadcrumb-item"><a href="./complex_error.html"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">An overview of complex error structures</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">An overview of complex error structures</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Luke Miratrix </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>In Unit 7 we talked about how we can model residuals around an overall population model using different specified structures on the correlation matrices for the students. This handout extends those topics, using the Raudenbush and Bryk Chapter 6 example on National Youth Survey data on deviant attitudes. We’re going to do a few things:</p>
<ol type="1">
<li><p>Reproduce the models in the book, showing you how to get them in R, using the commands <code>lme</code> and <code>gls</code>.</p></li>
<li><p>Discuss the relationship between <code>lme</code> and <code>gls</code>, and what it actually means when you include a gls-like “correlation” argument when calling <code>lme</code>. To make a long story short: <code>gls</code> is cleaner and more principled from a mathematical point of view, but in practice you will probably prefer hybrid calls using <code>lme</code>.</p></li>
<li><p>Give two ways this stuff can actually be useful – heteroskedasticity and AR[1] – and show how to fit realistic models with either and both. We’ll interpret and check significance of parameters as appropriate.</p></li>
</ol>
<section id="national-youth-survey-running-example" class="level2" data-number="51.1">
<h2 data-number="51.1" class="anchored" data-anchor-id="national-youth-survey-running-example"><span class="header-section-number">51.1</span> National Youth Survey running example</h2>
<p>Our running example is the data as described in Raudenbush and Bryk, and we follow the discussion on page 190. These data are the first cohort of the National Youth Survey (NYS). This data comes from a survey in which the same students were asked yearly about their acceptance of 9 “deviant”^[Wow, has the way we talk about things changed over the years.] behaviors (such as smoking marijuana, stealing, etc.). The study began in 1976, and followed two cohorts of children, starting at ages 11 and 14 respectively. We will analyze the first 5 years of data.</p>
<p>At each time point, we have measures of:</p>
<ul>
<li>ATTIT, the attitude towards deviance, with higher numbers implying higher tolerance for deviant behaviors.</li>
<li>EXPO, the “exposure”, based on asking the children how many friends they had who had engaged in each of the behaviors. Both of these numbers have been transformed to a logarithmic scale to reduce skew.</li>
</ul>
<p>For each student, we also have:</p>
<ul>
<li>Gender (binary)</li>
<li>Minority status (binary)</li>
<li>Family income, in units of $10K.</li>
</ul>
<p>One reasonable research question would to describe how the cohort evolved. For this question, the parameters of interest would be the average attitudes at each age. Standard deviations and intrasubject correlations are, as is often but not always the case, simply nuisance parameters. Still, the better we can do at realistically modeling these nuisance parameters, the more precision we will have for the measures of interest, and the power we will have to test relevant hypotheses.</p>
<section id="getting-the-data-ready" class="level3" data-number="51.1.1">
<h3 data-number="51.1.1" class="anchored" data-anchor-id="getting-the-data-ready"><span class="header-section-number">51.1.1</span> Getting the data ready</h3>
<p>We’ll focus on the first cohort, from ages 11-15. First, let’s read the data.</p>
<p>Note that this table is in “wide format”. That is, there is only one row for each student, with all the different observations for that student in different columns of that one row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>nyswide <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"data/nyswide.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nyswide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ID ATTIT.11 EXPO.11 ATTIT.12 EXPO.12 ATTIT.13 EXPO.13 ATTIT.14 EXPO.14
1  3     0.11   -0.37     0.20   -0.27     0.00   -0.37     0.00   -0.27
2  8     0.29    0.42     0.29    0.20     0.11    0.42     0.51    0.20
3  9     0.80    0.47     0.58    0.52     0.64    0.20     0.75    0.47
4 15     0.44    0.07     0.44    0.32     0.89    0.47     0.75    0.26
5 33     0.20   -0.27     0.64   -0.27     0.69   -0.27       NA      NA
6 45     0.11    0.26     0.37   -0.17     0.37    0.14     0.37    0.14
  ATTIT.15 EXPO.15 FEMALE MINORITY INCOME
1     0.11   -0.17      1        0      3
2     0.69    0.20      0        0      4
3     0.98    0.47      0        0      3
4     0.80    0.47      0        0      4
5     0.11    0.07      1        0      4
6     0.69    0.32      1        0      4</code></pre>
</div>
</div>
<p>For our purposes, we want it in “long format.” The <code>pivot_longer()</code> command does this for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>nys1.na <span class="ot">&lt;-</span> nyswide <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(ATTIT<span class="fl">.11</span><span class="sc">:</span>ATTIT<span class="fl">.15</span>, EXPO<span class="fl">.11</span><span class="sc">:</span>EXPO<span class="fl">.15</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">".value"</span>, <span class="st">"AGE"</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="fu">c</span>(<span class="st">"ATTIT"</span>, <span class="st">"EXPO"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Drop missing ATTIT values</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>nys1 <span class="ot">=</span> nys1.na[<span class="sc">!</span><span class="fu">is.na</span>(nys1.na<span class="sc">$</span>ATTIT),] </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Make age a number</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>AGE <span class="ot">=</span> <span class="fu">as.numeric</span>(nys1<span class="sc">$</span>AGE)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( nys1 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     ID FEMALE MINORITY INCOME   AGE ATTIT  EXPO
  &lt;int&gt;  &lt;int&gt;    &lt;int&gt;  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     3      1        0      3    11  0.11 -0.37
2     3      1        0      3    12  0.2  -0.27
3     3      1        0      3    13  0    -0.37
4     3      1        0      3    14  0    -0.27
5     3      1        0      3    15  0.11 -0.17
6     8      0        0      4    11  0.29  0.42</code></pre>
</div>
</div>
<p>We also need to make our age a factor so it is treated appropriately as an indicator of what wave the data was collected in.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>agefac <span class="ot">=</span> <span class="fu">as.factor</span>(nys1<span class="sc">$</span>AGE) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just to get a sense of the data, let’s plot each age as a boxplot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( nys1, <span class="fu">aes</span>( agefac, ATTIT ) ) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="complex_error_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note some features of the data: First, we see that ATTIT goes up over time. Second, we see the variation of points also goes up over time. This is heteroskedasticity.</p>
<p>If we plot individual lines we have</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>AGEjit <span class="ot">=</span> <span class="fu">jitter</span>(nys1<span class="sc">$</span>AGE)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>ATTITjit <span class="ot">=</span> <span class="fu">jitter</span>(nys1<span class="sc">$</span>ATTIT, <span class="at">amount=</span><span class="fl">0.05</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( <span class="fu">filter</span>( nys1, <span class="fu">complete.cases</span>(nys1) ), <span class="fu">aes</span>( AGEjit, ATTITjit, <span class="at">group=</span>ID ) ) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">alpha=</span><span class="fl">0.2</span> ) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="complex_error_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note how we have correlation of residuals, in that some students are systematically low and some are systematically higher (although there is a lot of bouncing around).</p>
</section>
</section>
<section id="representation-of-error-structure" class="level2" data-number="51.2">
<h2 data-number="51.2" class="anchored" data-anchor-id="representation-of-error-structure"><span class="header-section-number">51.2</span> Representation of error structure</h2>
<p>In our data, we have 5 observations <span class="math inline">\(y_{it}\)</span> for each subject i at 5 fixed times <span class="math inline">\(t=1\)</span> through <span class="math inline">\(t=5\)</span>. Within each person <span class="math inline">\(i\)</span> (where person is our Level-2 group, and time is our Level-1), we can write</p>
<p><span class="math display">\[\begin{pmatrix}y_{i1}\\
y_{i2}\\
y_{i3}\\
y_{i4}\\
y_{i5}
\end{pmatrix} = \left(\begin{array}{c}
\mu_{1i}\\
\mu_{2i}\\
\mu_{3i}\\
\mu_{4i}\\
\mu_{5i}
\end{array}\right) + \left(\begin{array}{c}
\epsilon_{1i}\\
\epsilon_{2i}\\
\epsilon_{3i}\\
\epsilon_{4i}\\
\epsilon_{5i}
\end{array}\right)\]</span> where our set of 5 residuals are the random part, distributed as</p>
<p><span class="math display">\[\left(\begin{array}{c}
\epsilon_{1i}\\
\epsilon_{2i}\\
\epsilon_{3i}\\
\epsilon_{4i}\\
\epsilon_{5i}
\end{array}\right)\sim N\left[\left(\begin{array}{c}
0\\
0\\
0\\
0\\
0
\end{array}\right),\left(\begin{array}{ccccc}
\tau_{11} &amp; \tau_{12} &amp; \tau_{13} &amp; \tau_{14} &amp; \tau_{15}\\
. &amp; \tau_{22} &amp; \tau_{23}&amp; \tau_{24} &amp; \tau_{25}\\
. &amp; . &amp; \tau_{33}&amp; \tau_{34} &amp; \tau_{35}\\
. &amp; . &amp; . &amp; \tau_{44} &amp; \tau_{45}\\
. &amp; . &amp; . &amp; . &amp; \tau_{55}
\end{array}\right)\right] = N( 0, \Sigma ). \]</span></p>
<p>The key part is the correlation between the residuals at different times. We call our entire covariance matrix <span class="math inline">\(\Sigma\)</span>. This matrix describes how the residuals within a single individual (with 5 time points of observation) are correlated.</p>
<p>Our regression model gives us the mean vector for any given student (e.g., <span class="math inline">\((\mu_{1i}, \ldots, \mu_{5i})\)</span> would be <span class="math inline">\(X_i'\beta\)</span>, where <span class="math inline">\(X_i\)</span> is a <span class="math inline">\(5 \times p\)</span> matrix of covariates for student <span class="math inline">\(i\)</span>, and <span class="math inline">\(\beta\)</span> is our fixed effect parameter vector. <span class="math inline">\(X_i\)</span> would have one row per time point and time would be one of the columns, to give our predictions for our 5 time points.</p>
<p>Our error structure model gives us the distribution of the <span class="math inline">\((\epsilon_{1i}, \ldots, \epsilon_{5i})\)</span> for student <span class="math inline">\(i\)</span>. Different ideas about the data generating process lead to different correlation structures here. We saw a couple of those in class.</p>
</section>
<section id="reproducing-rbs-chapter-6-examples" class="level2" data-number="51.3">
<h2 data-number="51.3" class="anchored" data-anchor-id="reproducing-rbs-chapter-6-examples"><span class="header-section-number">51.3</span> Reproducing R&amp;B’s Chapter 6 examples</h2>
<p>The above provides a framework for thinking about grouped data: each group (i.e., student) is a small world with a linear prediction line and a collection of residuals around that line. Under this view, we specify a specific structure on how the residuals relate to each other. (E.g., for classic OLS we would have i.i.d. normally distributed residuals, represented as our <span class="math inline">\(\Sigma\)</span> being a diagonal matrix with <span class="math inline">\(\sigma^2\)</span> along the diagonal and 0s everywhere else). In R, once we determine what structure we want, we can fit models based on parameterized correlation matrices using the <code>lme</code> command from the <code>nlme</code> package (You may need to first call <code>install.packages("nlme")</code> to get this package), or the <code>gls</code> package.</p>
<p>Let’s load the <code>nlme</code> package now:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nlme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that all of these models include a linear term on age and an intercept (so two fixed effects and no covariate adjustment).</p>
<section id="compound-symmetry-random-intercept-model" class="level3" data-number="51.3.1">
<h3 data-number="51.3.1" class="anchored" data-anchor-id="compound-symmetry-random-intercept-model"><span class="header-section-number">51.3.1</span> Compound symmetry (random intercept model)</h3>
<p>A “compound symmetry” residual covariance structure (all diagonal elements equal, all off-diagonal elements equal) is actually equivalent to a random intercepts model. Thus, there are 2 ways to get this same model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>modelRE <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> AGE, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>modelCompSymm <span class="ot">=</span> <span class="fu">gls</span>(ATTIT <span class="sc">~</span> AGE,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data=</span>nys1,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">correlation=</span><span class="fu">corCompSymm</span>(<span class="at">form=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For reference, using the <code>lme4</code> package we again have (we use <code>lme4::</code> in front of <code>lmer</code> to avoid loading the <code>lme4</code> package fully):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>modelRE.lme4 <span class="ot">=</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(ATTIT <span class="sc">~</span> AGE <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>ID), <span class="at">data=</span>nys1 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can get the correlation matrix for individuals #3:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>myVarCovs <span class="ot">=</span> <span class="fu">getVarCov</span>(modelRE,<span class="at">type=</span><span class="st">"marginal"</span>, <span class="at">individual=</span><span class="dv">3</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>myVarCovs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ID 9 
Marginal variance covariance matrix
         1        2        3        4        5
1 0.066450 0.034113 0.034113 0.034113 0.034113
2 0.034113 0.066450 0.034113 0.034113 0.034113
3 0.034113 0.034113 0.066450 0.034113 0.034113
4 0.034113 0.034113 0.034113 0.066450 0.034113
5 0.034113 0.034113 0.034113 0.034113 0.066450
  Standard Deviations: 0.25778 0.25778 0.25778 0.25778 0.25778 </code></pre>
</div>
</div>
<p>If we look at an individual #5, who only has 4 timepoints we get a <span class="math inline">\(4 \times 4\)</span> matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getVarCov</span>(modelRE,<span class="at">type=</span><span class="st">"marginal"</span>, <span class="at">individual=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ID 33 
Marginal variance covariance matrix
         1        2        3        4
1 0.066450 0.034113 0.034113 0.034113
2 0.034113 0.066450 0.034113 0.034113
3 0.034113 0.034113 0.066450 0.034113
4 0.034113 0.034113 0.034113 0.066450
  Standard Deviations: 0.25778 0.25778 0.25778 0.25778 </code></pre>
</div>
</div>
<p>Other individuals are the same, if they have the same number of time points, given our model. So in this model, we are saying the residuals of a student have the same distribution as any another student with the same number of time points.</p>
<section id="comparing-the-models" class="level4" data-number="51.3.1.1">
<h4 data-number="51.3.1.1" class="anchored" data-anchor-id="comparing-the-models"><span class="header-section-number">51.3.1.1</span> Comparing the models</h4>
<p>These are two very different ways of specifying the same thing, and the parameter estimates we get out are also not the same. Compare the two summary printouts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelRE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: nys1 
        AIC       BIC   logLik
  -204.9696 -185.0418 106.4848

Random effects:
 Formula: ~1 | ID
        (Intercept)  Residual
StdDev:   0.1846979 0.1798237

Fixed effects:  ATTIT ~ AGE 
                 Value  Std.Error  DF   t-value p-value
(Intercept) -0.5099954 0.05358498 839 -9.517505       0
AGE          0.0644387 0.00398784 839 16.158810       0
 Correlation: 
    (Intr)
AGE -0.969

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.90522949 -0.64353962 -0.01388485  0.60377631  3.26938845 

Number of Observations: 1079
Number of Groups: 239 </code></pre>
</div>
</div>
<p>and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelCompSymm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: ATTIT ~ AGE 
  Data: nys1 
        AIC       BIC   logLik
  -204.9696 -185.0418 106.4848

Correlation Structure: Compound symmetry
 Formula: ~AGE | ID 
 Parameter estimate(s):
      Rho 
0.5133692 

Coefficients:
                 Value  Std.Error   t-value p-value
(Intercept) -0.5099954 0.05358498 -9.517505       0
AGE          0.0644387 0.00398784 16.158810       0

 Correlation: 
    (Intr)
AGE -0.969

Standardized residuals:
        Min          Q1         Med          Q3         Max 
-1.77123071 -0.77132300 -0.06434029  0.71151900  3.38387884 

Residual standard error: 0.2577787 
Degrees of freedom: 1079 total; 1077 residual</code></pre>
</div>
</div>
<p>These do not look very similar, do they? But wait:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(modelCompSymm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' 106.4848 (df=4)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(modelRE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' 106.4848 (df=4)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(modelRE.lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'log Lik.' 106.4848 (df=4)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelCompSymm )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -204.9696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelRE )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -204.9696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelRE.lme4 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -204.9696</code></pre>
</div>
</div>
<p>In fact, they have the same AIC, etc., because they are equivalent models.</p>
<p>The lesson is that it’s actually quite hard to see the correspondence between a familiar random-effects model and an equivalent model expressed in terms of a covariance matrix. Sure, we could do a bunch of math and see that in the end they are the same; but that math is already daunting here, and this is the simplest possible situation. The fitted parameters of a covariance-based model are just really hard to interpret in familiar terms.</p>
</section>
</section>
<section id="autoregressive-error-structure-ar1" class="level3" data-number="51.3.2">
<h3 data-number="51.3.2" class="anchored" data-anchor-id="autoregressive-error-structure-ar1"><span class="header-section-number">51.3.2</span> Autoregressive error structure (AR[1])</h3>
<p>One typical structure used for longitudinal data is the “autoregressive” structure. The idea is threefold:</p>
<ol type="1">
<li><span class="math inline">\(Var(u_{it}) = \sigma^2\)</span> - that is, overall marginal variance is staying constant.</li>
<li><span class="math inline">\(Cor(u_{it},u_{i(t-1)}) = \rho\)</span> - that is, residuals are a little bit “sticky” over time so residuals from nearby time points tend to be similar.</li>
<li><span class="math inline">\(E(u_{it}|u_{i(t-1)},u_{i(t-2)}) = E(u_{it}|u_{i(t-1)})\)</span> - that is, the only way the two-periods-ago measurement tells you anything about the current one is through the intermediate one, with no longer-term effects or “momentum”.</li>
</ol>
<p>In this case, the unconditional two-step correlation <span class="math inline">\(Cor(u_{it},u_{i(t-2)})\)</span> is also easy to calculate. Intuitively, we can say that a portion <span class="math inline">\(\rho\)</span> of the residual “is the same” after each step, so that after two steps the portion that “is the same” is <span class="math inline">\(\rho\)</span> of <span class="math inline">\(\rho\)</span>, or <span class="math inline">\(\rho^2\)</span>. Clearly, then, after three steps the correlation will be <span class="math inline">\(\rho^3\)</span>, and so on. In other words, the part that “is the same” is decaying in an exponential pattern. Indeed, one could show that (3.), above, requires the correlated part to decay in a memoryless pattern, leaving the Exponential and Hypergeometric distributions (which both show exponential decay) among the few options.</p>
<p>Thus, the within-subject correlation structure implied by these postulates is:</p>
<p><span class="math display">\[\left(\begin{array}{c}
u_{1i}\\
u_{2i}\\
u_{3i}\\
u_{4i}\\
...\\
u_{ni}
\end{array}\right)\sim N\left[\left(\begin{array}{c}
0\\
0\\
0\\
0\\
...\\
0
\end{array}\right),\sigma^2\left(\begin{array}{cccccc}
1 &amp; \rho  &amp; \rho^2 &amp; \rho^3 &amp; ... &amp; \rho^{n-1}\\
. &amp; 1 &amp; \rho &amp; \rho^2 &amp; ... &amp; \rho^{n-2}\\
. &amp; . &amp; 1&amp; \rho  &amp; ... &amp; \rho^{n-3}\\
. &amp; . &amp; . &amp; 1 &amp; ... &amp; \rho^{n-4} \\
... &amp; ... &amp; ... &amp; ... &amp; ... &amp; ... \\
. &amp; . &amp; . &amp; . &amp; ... &amp; 1
\end{array}\right)\right]\\\]</span></p>
<p>As you can see, this structure takes advantage of the temporal nature of the data sequence to parameterize the covariance matrix with only two underlying parameters: <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\rho\)</span>. By contrast, a random intercept model needs the overall <span class="math inline">\(\sigma\)</span> and variance of intercepts <span class="math inline">\(\tau\)</span>—also two parameters! Same complexity, different structure.</p>
<section id="fitting-the-ar1-covariance-structure" class="level4" data-number="51.3.2.1">
<h4 data-number="51.3.2.1" class="anchored" data-anchor-id="fitting-the-ar1-covariance-structure"><span class="header-section-number">51.3.2.1</span> Fitting the AR[1] covariance structure</h4>
<p>To get a true AR[1] residual covariance structure, we need to leave the world of hierarchical models, and thus use the command <code>gls</code>. This is just what we’ve discussed in class. However, later on in this document, we’ll see how to add AR[1] structure on top of a hierarchical model, which is messier from a theoretical point of view, but often more useful and interpretable in practice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>modelAR1 <span class="ot">=</span> <span class="fu">gls</span>(ATTIT <span class="sc">~</span> AGE, </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data=</span>nys1,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">correlation=</span><span class="fu">corAR1</span>(<span class="at">form=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID) )</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelAR1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: ATTIT ~ AGE 
  Data: nys1 
        AIC       BIC   logLik
  -250.4103 -230.4826 129.2051

Correlation Structure: ARMA(1,0)
 Formula: ~AGE | ID 
 Parameter estimate(s):
     Phi1 
0.6159857 

Coefficients:
                 Value  Std.Error   t-value p-value
(Intercept) -0.4534647 0.07515703 -6.033564       0
AGE          0.0601205 0.00569797 10.551218       0

 Correlation: 
    (Intr)
AGE -0.987

Standardized residuals:
        Min          Q1         Med          Q3         Max 
-1.75013168 -0.81139621 -0.03256558  0.74814629  3.40350724 

Residual standard error: 0.2561765 
Degrees of freedom: 1079 total; 1077 residual</code></pre>
</div>
</div>
<p>You have to dig around in the large amount of output to find the parameter estimates, but they are there. <code>Phi1</code> is the auto-correlation parameter. And the covariance of residuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getVarCov</span>(modelAR1,<span class="at">type=</span><span class="st">"marginal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marginal variance covariance matrix
          [,1]     [,2]     [,3]     [,4]      [,5]
[1,] 0.0656260 0.040425 0.024901 0.015339 0.0094485
[2,] 0.0404250 0.065626 0.040425 0.024901 0.0153390
[3,] 0.0249010 0.040425 0.065626 0.040425 0.0249010
[4,] 0.0153390 0.024901 0.040425 0.065626 0.0404250
[5,] 0.0094485 0.015339 0.024901 0.040425 0.0656260
  Standard Deviations: 0.25618 0.25618 0.25618 0.25618 0.25618 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelAR1)<span class="sc">$</span>AIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -250.4103</code></pre>
</div>
</div>
<p>Note that the AIC of our AR[1] model is lower by about 45 than the random intercept model; clearly far superior because it is getting nearby residuals being more correlated, while the random intercept model does not do this. Also see the banding structure of the residual correlation matrix.</p>
</section>
</section>
<section id="random-slopes" class="level3" data-number="51.3.3">
<h3 data-number="51.3.3" class="anchored" data-anchor-id="random-slopes"><span class="header-section-number">51.3.3</span> Random slopes</h3>
<p>In theory, a random slopes model could be done with <code>gls</code> as well as with <code>lme</code> by building the final residual matrices as a function of the random slope parameters; in practice, it’s much more practical just to do it as a hierarchical model with <code>lme</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>modelRS <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> AGE, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have separated our fixed and random components with <code>lme()</code>. We first include a formula with only fixed effects, and then give a right-side-only formula with terms similar to what you’d put in parentheses with <code>lmer()</code> for the random effects.</p>
<p>Our results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelRS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: nys1 
       AIC       BIC   logLik
  -310.125 -280.2334 161.0625

Random effects:
 Formula: ~AGE | ID
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev     Corr  
(Intercept) 0.51024132 (Intr)
AGE         0.05038614 -0.98 
Residual    0.16265429       

Fixed effects:  ATTIT ~ 1 + AGE 
                 Value  Std.Error  DF  t-value p-value
(Intercept) -0.5133250 0.05834087 839 -8.79872       0
AGE          0.0646849 0.00492904 839 13.12323       0
 Correlation: 
    (Intr)
AGE -0.981

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.87852414 -0.55971196 -0.07521191  0.57495075  3.45648134 

Number of Observations: 1079
Number of Groups: 239 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getVarCov</span>(modelRS,<span class="at">type=</span><span class="st">"marginal"</span>, <span class="at">individual=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ID 9 
Marginal variance covariance matrix
         1        2        3        4        5
1 0.039649 0.015922 0.018650 0.021379 0.024108
2 0.015922 0.047646 0.026457 0.031725 0.036992
3 0.018650 0.026457 0.060720 0.042070 0.049876
4 0.021379 0.031725 0.042070 0.078872 0.062760
5 0.024108 0.036992 0.049876 0.062760 0.102100
  Standard Deviations: 0.19912 0.21828 0.24641 0.28084 0.31953 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelRS)<span class="sc">$</span>AIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -310.125</code></pre>
</div>
</div>
<p>The first thing to note is the residual covariance matrix comes from the structure of the random intercept and random slope. If you squint hard enough at it, you can begin to see the linear structures in its diagonal and off-diagonal elements. If you graphed it, those structures would jump out more clearly. But in practice, it’s much easier to think of things in terms of the hierarchical model, not in terms of linear structures in a covariance matrix.</p>
<p>Note also that the AIC has dropped by another 60 points or so; we’re continuing to improve the model.</p>
<p>Also note that this is just using a different package to fit the exact same model we would fit using <code>lmer</code>; so far we haven’t taken advantage of the <code>lme</code> command’s additional flexibility.</p>
</section>
<section id="random-slopes-with-heteroskedasticity" class="level3" data-number="51.3.4">
<h3 data-number="51.3.4" class="anchored" data-anchor-id="random-slopes-with-heteroskedasticity"><span class="header-section-number">51.3.4</span> Random slopes with heteroskedasticity</h3>
<p>Relaxing the homoskedasticity assumption in the random slopes model leaves us a bit in between worlds. We’re not fully into the world of GLS, because there are still random effects; but we’re not fully in the world of hierarchical models because there is structure in the residuals within groups. We’ll talk more about this compromise below; for now, let’s just do it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>modelRSH <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> AGE, </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">weights=</span><span class="fu">varIdent</span>(<span class="at">form=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>agefac) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key line is the <code>varIdent</code> line: we are saying each age factor level gets its own weight (rescaling) of the residuals—this is heteroskedasticity. In particular, the above says our residual variance will be weighted by a weight for each age factor, so each age level effectively gets its own variance. This is where these models start to get a bit exciting—we have random slopes, and then heteroskedastic residuals (homoskedastic for any given age level), all together. Our fit model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelRSH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: nys1 
        AIC       BIC   logLik
  -312.5801 -262.7608 166.2901

Random effects:
 Formula: ~AGE | ID
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev     Corr  
(Intercept) 0.57693602 (Intr)
AGE         0.05431367 -0.979
Residual    0.14054184       

Variance function:
 Structure: Different standard deviations per stratum
 Formula: ~1 | agefac 
 Parameter estimates:
       11        12        13        14        15 
1.0000000 1.1956071 1.3095864 1.1255177 0.9802311 
Fixed effects:  ATTIT ~ AGE 
                 Value  Std.Error  DF   t-value p-value
(Intercept) -0.4929012 0.05715889 839 -8.623351       0
AGE          0.0631404 0.00483385 839 13.062122       0
 Correlation: 
    (Intr)
AGE -0.981

Standardized Within-Group Residuals:
       Min         Q1        Med         Q3        Max 
-2.9163540 -0.5498217 -0.0758348  0.5482942  3.2370312 

Number of Observations: 1079
Number of Groups: 239 </code></pre>
</div>
</div>
<p>Note how we have 5 parameter estimates for the residuals, listed under <code>agefac</code>. It appears as if we have more variation in age 13 than other ages. Age 11, the baseline, is 1.0; it is our reference scaling. These numbers are all scaling the overall residual variance parameter <span class="math inline">\(\sigma^2\)</span> of <span class="math inline">\(0.1405^2\)</span>.</p>
<p>For looking at the covariance structure of the residuals, we use <code>getVarCov()</code> again:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>myVarCov <span class="ot">=</span> <span class="fu">getVarCov</span>(modelRSH,<span class="at">type=</span><span class="st">"marginal"</span>, <span class="at">individual=</span><span class="dv">3</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>myVarCov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ID 9 
Marginal variance covariance matrix
         1        2        3        4        5
1 0.034915 0.016947 0.018731 0.020516 0.022300
2 0.016947 0.049916 0.026415 0.031150 0.035884
3 0.018731 0.026415 0.067975 0.041784 0.049468
4 0.020516 0.031150 0.041784 0.077440 0.063052
5 0.022300 0.035884 0.049468 0.063052 0.095615
  Standard Deviations: 0.18685 0.22342 0.26072 0.27828 0.30922 </code></pre>
</div>
</div>
<p>We get lists of matrices back from our call. We can convert any one to a correlation matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cov2cor</span>(myVarCov[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1         2         3         4         5
1 1.0000000 0.4059446 0.3844935 0.3945453 0.3859525
2 0.4059446 1.0000000 0.4534860 0.5010159 0.5194173
3 0.3844935 0.4534860 1.0000000 0.5759089 0.6136046
4 0.3945453 0.5010159 0.5759089 1.0000000 0.7327497
5 0.3859525 0.5194173 0.6136046 0.7327497 1.0000000</code></pre>
</div>
</div>
<p>No amount of squinting will show the structure in the original covariance matrix. But when you convert to a correlation matrix, you can again squint and begin to see the linear structures in its diagonal and off-diagonal elements. The same comment as above still applies: in practice, it’s much easier to think of things in terms of the hierarchical model, and only read the diagonals of the covariance matrix.</p>
<p>We can also get our AIC:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelRSH)<span class="sc">$</span>AIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -312.5801</code></pre>
</div>
</div>
<p>The AIC has dropped by only another 2.5 points or so; that corresponds to the idea that if one of these two models were exactly true, the odds are about <span class="math inline">\(e^{2.5/2}\cong 3.5\)</span> in favor of the more complex model. Aside from the fact that that premise is silly – we are pretty sure that neither of these models is the exact truth; and in that case, something like BIC would probably be better than AIC – those odds are also pretty weak; the simpler model is probably better here.</p>
<p>Here’s the reported BICs, by the way: -280.2334145 for the homoskedastic one, and -262.7607678 for the heteroskedastic. As we expected, the simpler model wins that fight. (Though what <span class="math inline">\(N\)</span> to use for BIC is sometimes not obvious with hierarchical models, so you can’t trust those numbers too much; see the unit on AIC and BIC and model building.)</p>
</section>
<section id="fully-unrestricted-model" class="level3" data-number="51.3.5">
<h3 data-number="51.3.5" class="anchored" data-anchor-id="fully-unrestricted-model"><span class="header-section-number">51.3.5</span> Fully unrestricted model</h3>
<p>OK, let’s go whole hog, and fit the unrestricted model. Again, this means leaving the world of hierarchical models and using gls.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>modelUnrestricted <span class="ot">=</span> <span class="fu">gls</span>(ATTIT <span class="sc">~</span> AGE, </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data=</span>nys1,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">correlation=</span><span class="fu">corSymm</span>(<span class="at">form=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights=</span><span class="fu">varIdent</span>(<span class="at">form=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>agefac) )</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelUnrestricted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Generalized least squares fit by REML
  Model: ATTIT ~ AGE 
  Data: nys1 
       AIC       BIC  logLik
  -319.262 -234.5691 176.631

Correlation Structure: General
 Formula: ~1 | ID 
 Parameter estimate(s):
 Correlation: 
  1     2     3     4    
2 0.458                  
3 0.372 0.511            
4 0.441 0.437 0.663      
5 0.468 0.443 0.597 0.764
Variance function:
 Structure: Different standard deviations per stratum
 Formula: ~1 | agefac 
 Parameter estimates:
      11       12       13       14       15 
1.000000 1.118479 1.414269 1.522510 1.560074 

Coefficients:
                 Value  Std.Error   t-value p-value
(Intercept) -0.4557090 0.05465564 -8.337822       0
AGE          0.0597274 0.00458344 13.031145       0

 Correlation: 
    (Intr)
AGE -0.979

Standardized residuals:
         Min           Q1          Med           Q3          Max 
-1.482606297 -0.809004080 -0.006791942  0.840804584  4.082258054 

Residual standard error: 0.1903187 
Degrees of freedom: 1079 total; 1077 residual</code></pre>
</div>
</div>
<p>And our residual structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>myvc <span class="ot">=</span> <span class="fu">getVarCov</span>(modelUnrestricted,<span class="at">type=</span><span class="st">"marginal"</span>, <span class="at">individual=</span><span class="dv">3</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>myvc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Marginal variance covariance matrix
         [,1]     [,2]     [,3]     [,4]     [,5]
[1,] 0.036221 0.018541 0.019071 0.024335 0.026466
[2,] 0.018541 0.045313 0.029251 0.026924 0.027989
[3,] 0.019071 0.029251 0.072448 0.051703 0.047736
[4,] 0.024335 0.026924 0.051703 0.083962 0.065764
[5,] 0.026466 0.027989 0.047736 0.065764 0.088156
  Standard Deviations: 0.19032 0.21287 0.26916 0.28976 0.29691 </code></pre>
</div>
</div>
<p>And AIC:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelUnrestricted )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -319.262</code></pre>
</div>
</div>
<p>This unrestricted covariance and correlation matrices have the same structures discussed in the book and in class. The AIC has improved by another 6 or 7 points; that’s marginally “significant”, but in practice probably not substantial enough to make up for the massive loss of interpretability. The lesson we should take from that is that there’s not a whole lot of room for improvement just by tinkering with the residual covariance structure; if we want a much better model, we would have to add new fixed or random effects; perhaps other covariates or perhaps a quadratic term in time.</p>
</section>
</section>
<section id="having-both-ar1-and-random-slopes" class="level2" data-number="51.4">
<h2 data-number="51.4" class="anchored" data-anchor-id="having-both-ar1-and-random-slopes"><span class="header-section-number">51.4</span> Having both AR[1] and Random Slopes</h2>
<p>Let’s look at an AR1 residual structure along with some covariates in our main model. The following has AR[1] and <em>also</em> a random intercept and slope:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>AGE11 <span class="ot">=</span> nys1<span class="sc">$</span>AGE <span class="sc">-</span> <span class="dv">11</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">lmeControl</span>(<span class="at">opt=</span><span class="st">'optim'</span>);</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">=</span> <span class="fu">lme</span>(<span class="at">fixed=</span>ATTIT <span class="sc">~</span> AGE11 <span class="sc">+</span> EXPO <span class="sc">+</span> FEMALE <span class="sc">+</span> MINORITY <span class="sc">+</span> <span class="fu">log</span>(INCOME <span class="sc">+</span> <span class="dv">1</span>), </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span> <span class="sc">+</span> AGE11<span class="sc">|</span>ID,</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">correlation=</span><span class="fu">corAR1</span>(),</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">control =</span> ctrl )</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: nys1 
       AIC       BIC   logLik
  -444.203 -389.4427 233.1015

Random effects:
 Formula: ~1 + AGE11 | ID
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev     Corr  
(Intercept) 0.07999781 (Intr)
AGE11       0.03332789 0.718 
Residual    0.16897903       

Correlation Structure: AR(1)
 Formula: ~1 | ID 
 Parameter estimate(s):
      Phi 
0.1868886 
Fixed effects:  ATTIT ~ AGE11 + EXPO + FEMALE + MINORITY + log(INCOME + 1) 
                      Value  Std.Error  DF   t-value p-value
(Intercept)      0.26483469 0.04070122 838  6.506800  0.0000
AGE11            0.04972825 0.00463402 838 10.731129  0.0000
EXPO             0.31452987 0.02489980 838 12.631823  0.0000
FEMALE          -0.01661080 0.02027639 235 -0.819219  0.4135
MINORITY        -0.06296592 0.02676263 235 -2.352755  0.0195
log(INCOME + 1) -0.00943584 0.02359588 235 -0.399893  0.6896
 Correlation: 
                (Intr) AGE11  EXPO   FEMALE MINORI
AGE11           -0.123                            
EXPO            -0.064 -0.225                     
FEMALE          -0.181 -0.038  0.171              
MINORITY        -0.491  0.008  0.011 -0.030       
log(INCOME + 1) -0.923 -0.004  0.084 -0.054  0.407

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.61795250 -0.58685208 -0.08121038  0.57649581  2.82037550 

Number of Observations: 1079
Number of Groups: 239 </code></pre>
</div>
</div>
<p>In order to get this model to converge, we had to use the <code>lmeControl</code> command above; without it, the model doesn’t converge due to not reaching a max in the given number of iterations. The <code>lmeControl</code> with <code>optim</code> apparently turns up the juice so it converges without complaint.</p>
<p>Let’s compare our fit model to the same model without AR1 correlation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>model1simple <span class="ot">=</span> <span class="fu">lme</span>(<span class="at">fixed=</span>ATTIT <span class="sc">~</span> AGE11 <span class="sc">+</span> EXPO <span class="sc">+</span> FEMALE <span class="sc">+</span> MINORITY <span class="sc">+</span> <span class="fu">log</span>(INCOME <span class="sc">+</span> <span class="dv">1</span>), </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>nys1,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span> <span class="sc">+</span> AGE11<span class="sc">|</span>ID )</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>( <span class="fu">list</span>( <span class="at">AR=</span>model1, <span class="at">noAR=</span>model1simple ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=========================================
                 AR           noAR       
-----------------------------------------
(Intercept)         0.26 ***     0.26 ***
                   (0.04)       (0.04)   
AGE11               0.05 ***     0.05 ***
                   (0.00)       (0.00)   
EXPO                0.31 ***     0.32 ***
                   (0.02)       (0.02)   
FEMALE             -0.02        -0.02    
                   (0.02)       (0.02)   
MINORITY           -0.06 *      -0.06 *  
                   (0.03)       (0.03)   
log(INCOME + 1)    -0.01        -0.01    
                   (0.02)       (0.02)   
-----------------------------------------
AIC              -444.20      -436.80    
BIC              -389.44      -387.02    
Log Likelihood    233.10       228.40    
Num. obs.        1079         1079       
Num. groups: ID   239          239       
=========================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>The AR1 model has a notably lower AIC and thus is significantly better:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>( model1simple, model1 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Model df       AIC       BIC   logLik   Test  L.Ratio p-value
model1simple     1 10 -436.8027 -387.0206 228.4014                        
model1           2 11 -444.2030 -389.4427 233.1015 1 vs 2 9.400292  0.0022</code></pre>
</div>
</div>
<p>Autoregression involves only a single extra parameter–the autoregressive correlation coefficient.</p>
<p>Our hybrid model is actually kind of mixed up, conceptually. We allowed a random slope on age, and also an autoregressive component by age. Thus, we effectively allowed the covariance matrix to vary in two different ways, at two different levels of our modeling.</p>
<p>In fact, as we’ve seen in class, any random effects, whether they be on slope or intercept, are actually equivalent to certain ways of varying the variance-covariance matrix of the residuals within each group. For instance, random intercepts are equivalent to compound symmetry. Thus, by including both random intercepts and AR1 correlation in the above model, we’ve effectively fit a model that allows any covariance matrix that can be expressed as a sum of a random slope covariance matrix (with 2 parameters plus a scaling factor) and an AR1 covariance matrix (with 1 parameter plus a scaling factor). That makes 5 degrees of freedom total for our covariance matrix. This is many fewer than the 15 for a fully unconstrained matrix, for comparison.</p>
<p>Conceptually this model is nice: people have linear growth trends, but vary around those growth trends in an autoregressive way.</p>
</section>
<section id="the-kitchen-sink-building-complex-models" class="level2" data-number="51.5">
<h2 data-number="51.5" class="anchored" data-anchor-id="the-kitchen-sink-building-complex-models"><span class="header-section-number">51.5</span> The Kitchen sink: building complex models</h2>
<p>Which brings us to the next point: how do you actually use this stuff in practice? Ideally, you’d like both the interpretability (and robustness against MAR missingness) of hierarchical models, along with the ability to add additional residual structure such as AR[1] and/or heteroskedastic residuals. The good news is, you can get both. The bad news is, there’s a bit of a potential for bias due to overfitting.</p>
<p>For instance, imagine you use both random effects and AR[1]. Say that for a given subject you have 5 time points, and all of them are above the values you would have predicted based on fixed effects alone. That might be explained by an above-average random effect, or by a set of correlated residuals that all came in high. Whichever one of these is the “true” explanation, the MLE will tend to parcel it out between the two. This can lead to downward bias in variance and/or correlation parameter estimates, especially with small numbers of observations per subject–the variation gets pushed into just assuming the residuals are correlated due to the auto-regressive structure.</p>
<p>Still, as long as your focus is on location parameters such as true means or slopes, having hybrid models can be a good way to proceed. Let’s explore this by first fitting a “kitchen sink” model for this data, in which we use all available covariates; and seeing how adding heteroskedasticity, AR[1] structure, or both changes it (or doesn’t).</p>
<p>What do we want in this “kitchen sink” model? Let’s first fit a very simple random intercept model with fixed effects for gender, minority status, “exposure”, and log(income), to see which of these covariates to focus on. We use the <code>lmerTest</code> package to get some early <span class="math inline">\(p\)</span>-values for these fixed effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>modelKS0 <span class="ot">=</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(ATTIT <span class="sc">~</span> FEMALE <span class="sc">+</span> MINORITY <span class="sc">+</span> <span class="fu">log</span>(INCOME <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> EXPO <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>ID), <span class="at">data=</span>nys1)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modelKS0, <span class="at">correlation=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: ATTIT ~ FEMALE + MINORITY + log(INCOME + 1) + EXPO + (1 | ID)
   Data: nys1

REML criterion at convergence: -265.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.1840 -0.5922 -0.0797  0.6043  2.6319 

Random effects:
 Groups   Name        Variance Std.Dev.
 ID       (Intercept) 0.01756  0.1325  
 Residual             0.03444  0.1856  
Number of obs: 1079, groups:  ID, 239

Fixed effects:
                  Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)      3.480e-01  4.195e-02  2.301e+02   8.297    9e-15 ***
FEMALE          -1.835e-02  2.094e-02  2.327e+02  -0.876   0.3819    
MINORITY        -5.698e-02  2.789e-02  2.279e+02  -2.043   0.0422 *  
log(INCOME + 1)  2.102e-03  2.449e-02  2.272e+02   0.086   0.9317    
EXPO             4.516e-01  2.492e-02  1.041e+03  18.122   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>(The <code>correlation=FALSE</code> shortens the printout.)</p>
<p>Apparently, MINORITY and EXPO are the covariates with significant effects; minority status is correlated with a lower tolerance for deviance, while “deviant” friends are of course correlated positively with tolerance of deviance. Let’s build a few hierarchical models including these in various specifications (can you identify what models are what? Some of these models are not necessarily good choices). We first center our age so we have meaningful intercepts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>nys1<span class="sc">$</span>age13 <span class="ot">=</span> nys1<span class="sc">$</span>AGE <span class="sc">-</span> <span class="dv">13</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>modelKS1 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span>age13 <span class="sc">+</span> EXPO<span class="sc">|</span>ID )</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>modelKS2 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13, </span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span>age13 <span class="sc">+</span> EXPO<span class="sc">|</span>ID )</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>modelKS3 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13, </span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span>EXPO<span class="sc">|</span>ID )</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>modelKS4 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13 <span class="sc">+</span> EXPO, </span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we examine them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( texreg )</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">screenreg</span>( <span class="fu">list</span>( modelKS1, modelKS2, modelKS3, modelKS4 ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
===================================================================
                 Model 1      Model 2      Model 3      Model 4    
-------------------------------------------------------------------
(Intercept)         0.31 ***     0.31 ***     0.29 ***     0.34 ***
                   (0.01)       (0.01)       (0.01)       (0.01)   
MINORITY           -0.05 *      -0.05 *      -0.04        -0.06 *  
                   (0.02)       (0.02)       (0.03)       (0.03)   
age13               0.06 ***     0.06 ***     0.05 ***     0.05 ***
                   (0.00)       (0.00)       (0.00)       (0.00)   
EXPO                                                       0.37 ***
                                                          (0.02)   
-------------------------------------------------------------------
AIC              -374.18      -374.18      -312.13      -394.06    
BIC              -324.37      -324.37      -277.27      -364.18    
Log Likelihood    197.09       197.09       163.07       203.03    
Num. obs.        1079         1079         1079         1079       
Num. groups: ID   239          239          239          239       
===================================================================
*** p &lt; 0.001; ** p &lt; 0.01; * p &lt; 0.05</code></pre>
</div>
</div>
<p>OK, Number 4 seems like a pretty good model. Let’s see how much it improves when we add AR[1]:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>modelKS5 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13 <span class="sc">+</span> EXPO, </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">correlation=</span><span class="fu">corAR1</span>(<span class="at">form=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID) )</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelKS5 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -433.5943</code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>( modelKS4 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    MINORITY       age13        EXPO 
 0.34054593 -0.05606947  0.04830698  0.36778951 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>( modelKS5 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    MINORITY       age13        EXPO 
 0.34083507 -0.05704474  0.04733879  0.35207989 </code></pre>
</div>
</div>
<p>Note that the estimates for all the effects are essentially unchanged. However, the AIC is almost 40 points better. Also, because the model has done a better job explaining residual variance, the <span class="math inline">\(p\)</span>-value for the coefficient on MINORITY has dropped from 0.032 to 0.029, as we can see on the summary display below. This is not a large drop, but a noticeable one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>( modelKS5 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by REML
  Data: nys1 
        AIC       BIC   logLik
  -433.5943 -398.7338 223.7972

Random effects:
 Formula: ~1 | ID
        (Intercept)  Residual
StdDev:   0.1186009 0.1864592

Correlation Structure: ARMA(1,0)
 Formula: ~AGE | ID 
 Parameter estimate(s):
     Phi1 
0.3212696 
Fixed effects:  ATTIT ~ MINORITY + age13 + EXPO 
                 Value   Std.Error  DF   t-value p-value
(Intercept)  0.3408351 0.011858053 838 28.742920   0.000
MINORITY    -0.0570447 0.025968587 237 -2.196683   0.029
age13        0.0473388 0.004523745 838 10.464512   0.000
EXPO         0.3520799 0.024451130 838 14.399330   0.000
 Correlation: 
         (Intr) MINORI age13 
MINORITY -0.457              
age13    -0.013  0.010       
EXPO      0.006 -0.001 -0.224

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.82097989 -0.65136103 -0.08846076  0.61819746  2.77303796 

Number of Observations: 1079
Number of Groups: 239 </code></pre>
</div>
</div>
<p>Is any of this drop in the <span class="math inline">\(p\)</span>-value due to overfitting? Given the size of the change in AIC, it seems doubtful that that’s a significant factor.</p>
<p>Let’s try including heteroskedasticity, without AR[1]:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>modelKS6 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13 <span class="sc">+</span> EXPO, </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">weights=</span><span class="fu">varIdent</span>(<span class="at">form=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>agefac) )</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelKS6 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -389.5696</code></pre>
</div>
</div>
<p>This did not improve AIC in this case, so we can avoid looking at this model further.</p>
<p>For completeness, let’s look at a model with both AR(1) and heteroskedasticity:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>modelKS7 <span class="ot">=</span> <span class="fu">lme</span>(ATTIT <span class="sc">~</span> MINORITY <span class="sc">+</span> age13 <span class="sc">+</span> EXPO, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nys1,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">random=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>ID,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">correlation=</span><span class="fu">corAR1</span>(<span class="at">form=</span><span class="sc">~</span>AGE<span class="sc">|</span>ID),</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">weights=</span><span class="fu">varIdent</span>(<span class="at">form=</span><span class="sc">~</span><span class="dv">1</span><span class="sc">|</span>agefac) )</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>( modelKS7 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -431.1943</code></pre>
</div>
</div>
<p>Again, no improvement. So we settle with our AR[1] model with a random intercept to get overall level of a student.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./cov_matrix_derivation.html" class="pagination-link" aria-label="Covariance Derivation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Covariance Derivation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./cluster_demo.html" class="pagination-link" aria-label="Walk-through of calculating robust standard errors">
        <span class="nav-page-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Walk-through of calculating robust standard errors</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>