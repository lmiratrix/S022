<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Luke Miratrix">

<title>39&nbsp; Code for HSB Example in Chapter 4 of R&amp;B â€“ Resources for S043/Stat151: Multilevel and Longitudinal Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./faraway_ex.html" rel="next">
<link href="./robust_mlm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./hsb_ex.html">WORKED EXAMPLES</a></li><li class="breadcrumb-item"><a href="./hsb_ex.html"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Code for HSB Example in Chapter 4 of R&amp;B</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Resources for S043/Stat151: Multilevel and Longitudinal Models</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./self_assess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Do I take S-043? A self-assessment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Started with R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assignment_guidelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment Formatting Guidelines</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./self_grading.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self Grading Instructions</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">R &amp; R MARKDOWN</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./style_guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">An R Code Style Guide (Miratrix version)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_markdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intro to R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./configuring_code_chunks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Configuring Rmarkdown chunks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_linear_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intro to Regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summarizing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Summarizing and exploring data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./making_tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Making tables in Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reg_table_demo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Making Regression and ANOVA Tables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diagnostic_plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Regression diagnostic plots for MLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./math_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">A Math Reference: Sample Modeling Equations to Borrow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pivot_wider.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title"><code>pivot_longer</code> and <code>pivot_wider</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_missing_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">An Introduction to Missing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r_tips.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Tips, Tricks, and Debugging in R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">USING ggPLOT</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_ggplot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Intro to <code>ggplot</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./plot_expand_grid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Example of making plots with <code>expand.grid</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ggeffects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Easy viz for multilevel models with <code>ggeffects</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coefficient_plots.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Coefficient Plots</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./double_plot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Plotting Two Datasets at Once</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">MODEL FITTING &amp; INTERPRETATION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./examining_shrinkage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">How Empirical Bayes over-shrinks</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./broom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Extracting information from fitted <code>lmer</code> models with <code>broom</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lmer_extract.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Extrating information from fitted <code>lmer</code> models using base R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpreting_coefficients.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Interpreting Coefficients</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./within_v_between.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Within, Between, and Contextual Effects</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visual_tour_of_nulls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">A visual guide to parameters</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reg_assumptions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">MLM Assumptions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_representations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Model Representations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model_cheat_sheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Connecting the three dots: An HSB Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./growth_models_predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Predictors in Longitudinal Growth Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interpreting_glms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Interpreting GLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lr_test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Likelihood Ratio Tests</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./aic_check.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">AIC, BIC, and Deviance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lmer_optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Optimization Algorithms for MLMs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bootstrap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Bootstrapping clustered data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survey_weights.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Survey Weights</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">A flexible longitudinal model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">FIXED EFFECTS and FRIENDS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pooling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Pooling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fixed_effects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Clarification on Fixed Effects and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fe_crve.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">A tour of fixed effects and cluster-robust SEs</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./robust_mlm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">MLM and Cluster-Robust Standard Errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">WORKED EXAMPLES</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hsb_ex.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Code for HSB Example in Chapter 4 of R&amp;B</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./faraway_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Code for Faraway Example</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./perf_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Example of a three-level model of clustered data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kenya_ex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Example of a three-level longitudinal model</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">VISUALIZATIONS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./icc_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">ICC Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rand_slopes_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Random Slopes Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rewb_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Within vs Between / Contextual Effects Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./centering_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Centering Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./latent_logit_viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Latent Logit/LPM Visualization</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">MATH DERIVATIONS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./icc_derivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">ICC Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inflated_variance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Inflated Variance Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cov_matrix_derivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Covariance Derivation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./complex_error.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">An overview of complex error structures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cluster_demo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Walk-through of calculating robust standard errors</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#r-setup" id="toc-r-setup" class="nav-link active" data-scroll-target="#r-setup"><span class="header-section-number">39.1</span> R Setup</a></li>
  <li><a href="#load-hsb-data" id="toc-load-hsb-data" class="nav-link" data-scroll-target="#load-hsb-data"><span class="header-section-number">39.2</span> Load HS&amp;B data</a></li>
  <li><a href="#table-4.1-descriptive-summaries" id="toc-table-4.1-descriptive-summaries" class="nav-link" data-scroll-target="#table-4.1-descriptive-summaries"><span class="header-section-number">39.3</span> Table 4.1 Descriptive summaries</a></li>
  <li><a href="#table-4.2-one-way-anova-i.e-uncontrolled-random-intercept" id="toc-table-4.2-one-way-anova-i.e-uncontrolled-random-intercept" class="nav-link" data-scroll-target="#table-4.2-one-way-anova-i.e-uncontrolled-random-intercept"><span class="header-section-number">39.4</span> Table 4.2: One-Way ANOVA (i.e uncontrolled random intercept)</a></li>
  <li><a href="#table-4.3-means-as-outcomes-model" id="toc-table-4.3-means-as-outcomes-model" class="nav-link" data-scroll-target="#table-4.3-means-as-outcomes-model"><span class="header-section-number">39.5</span> Table 4.3 Means as Outcomes Model</a></li>
  <li><a href="#table-4.4-random-coefficient-model-i.e.-random-slope" id="toc-table-4.4-random-coefficient-model-i.e.-random-slope" class="nav-link" data-scroll-target="#table-4.4-random-coefficient-model-i.e.-random-slope"><span class="header-section-number">39.6</span> Table 4.4 Random coefficient model (i.e.&nbsp;random slope)</a></li>
  <li><a href="#table-4.5-intercepts-and-slopes-as-outcomes-model" id="toc-table-4.5-intercepts-and-slopes-as-outcomes-model" class="nav-link" data-scroll-target="#table-4.5-intercepts-and-slopes-as-outcomes-model"><span class="header-section-number">39.7</span> Table 4.5 Intercepts and Slopes as Outcomes Model</a></li>
  <li><a href="#figure-4.1" id="toc-figure-4.1" class="nav-link" data-scroll-target="#figure-4.1"><span class="header-section-number">39.8</span> Figure 4.1</a></li>
  <li><a href="#set-up-for-remaining-tablesfigures-of-chapter" id="toc-set-up-for-remaining-tablesfigures-of-chapter" class="nav-link" data-scroll-target="#set-up-for-remaining-tablesfigures-of-chapter"><span class="header-section-number">39.9</span> Set-up for remaining tables/figures of chapter</a></li>
  <li><a href="#table-4.6-comparing-site-specific-estimates-from-different-models" id="toc-table-4.6-comparing-site-specific-estimates-from-different-models" class="nav-link" data-scroll-target="#table-4.6-comparing-site-specific-estimates-from-different-models"><span class="header-section-number">39.10</span> Table 4.6 Comparing site-specific estimates from different models</a></li>
  <li><a href="#figure-4.2-scatter-plots-of-the-estimates-from-2-unconstrained-models" id="toc-figure-4.2-scatter-plots-of-the-estimates-from-2-unconstrained-models" class="nav-link" data-scroll-target="#figure-4.2-scatter-plots-of-the-estimates-from-2-unconstrained-models"><span class="header-section-number">39.11</span> Figure 4.2 : Scatter plots of the estimates from 2 unconstrained models</a></li>
  <li><a href="#figure-4.3-scatter-plots-of-residuals-from-the-ols-constrained-mlm-model" id="toc-figure-4.3-scatter-plots-of-residuals-from-the-ols-constrained-mlm-model" class="nav-link" data-scroll-target="#figure-4.3-scatter-plots-of-residuals-from-the-ols-constrained-mlm-model"><span class="header-section-number">39.12</span> Figure 4.3 : Scatter plots of residuals from the OLS &amp; Constrained MLM model</a></li>
  <li><a href="#table-4.7-pg-94" id="toc-table-4.7-pg-94" class="nav-link" data-scroll-target="#table-4.7-pg-94"><span class="header-section-number">39.13</span> Table 4.7 : pg 94</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./hsb_ex.html">WORKED EXAMPLES</a></li><li class="breadcrumb-item"><a href="./hsb_ex.html"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Code for HSB Example in Chapter 4 of R&amp;B</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Code for HSB Example in Chapter 4 of R&amp;B</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Luke Miratrix </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>This script builds everything from Chapter 4 of Raudenbush and Bryk in R. It is a very useful script for getting pretty much all the code you would need for a conventional multilevel analysis. The code is divided by each table or plot from the chapter.</p>
<section id="r-setup" class="level2" data-number="39.1">
<h2 data-number="39.1" class="anchored" data-anchor-id="r-setup"><span class="header-section-number">39.1</span> R Setup</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreign) <span class="co">#this lets us read in spss files</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#this is a broad package that allows us to do lots of data management-y things (and ggplot!)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4) <span class="co">#this allows us to run MLM</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm) <span class="co">#this allows us to display MLM</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( lmerTest ) <span class="co"># this puts p-values on the summary() command for fixed effects</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-hsb-data" class="level2" data-number="39.2">
<h2 data-number="39.2" class="anchored" data-anchor-id="load-hsb-data"><span class="header-section-number">39.2</span> Load HS&amp;B data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read student data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>stud.dat <span class="ot">=</span> <span class="fu">read.spss</span>( <span class="st">"data/hsb1.sav"</span>, <span class="at">to.data.frame=</span><span class="cn">TRUE</span> )</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in school data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>sch.dat <span class="ot">=</span> <span class="fu">read.spss</span>( <span class="st">"data/hsb2.sav"</span>, <span class="at">to.data.frame=</span><span class="cn">TRUE</span> )</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make single data frame with all variables, keep all students even if they</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># don't match to a school</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">merge</span>( stud.dat, sch.dat, <span class="at">by=</span><span class="st">"id"</span>, <span class="at">all.x=</span><span class="cn">TRUE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="table-4.1-descriptive-summaries" class="level2" data-number="39.3">
<h2 data-number="39.3" class="anchored" data-anchor-id="table-4.1-descriptive-summaries"><span class="header-section-number">39.3</span> Table 4.1 Descriptive summaries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get mean and SD of the Level 1 variables, rounded to 2 decimal places</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># math achievement</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>mathach),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 12.75</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sd</span>(dat<span class="sc">$</span>mathach),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.88</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ses</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">mean</span>(dat<span class="sc">$</span>ses),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sd</span>(dat<span class="sc">$</span>ses),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.78</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get mean and SD of Level 2 variables, round to 2 decimal places</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: we are getting these from the SCHOOL-LEVEL FILE</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sector</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">mean</span>(sch.dat<span class="sc">$</span>sector),<span class="dv">2</span>) <span class="co"># this answers "what percent of schools are catholic?"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.44</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sd</span>(sch.dat<span class="sc">$</span>sector),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mean ses</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">mean</span>(sch.dat<span class="sc">$</span>meanses),<span class="dv">2</span>) <span class="co"># this answers "what is the average of the school-average SES values?"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sd</span>(sch.dat<span class="sc">$</span>meanses),<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.41</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: if we used the student-level or "dat" file, we would be answering the</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># following questions:</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># * what percent of students attend a catholic school?</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># * what is the average student ses? &lt;- this would match what we calculated</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ourselves if we had the entire school in our sample</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="table-4.2-one-way-anova-i.e-uncontrolled-random-intercept" class="level2" data-number="39.4">
<h2 data-number="39.4" class="anchored" data-anchor-id="table-4.2-one-way-anova-i.e-uncontrolled-random-intercept"><span class="header-section-number">39.4</span> Table 4.2: One-Way ANOVA (i.e uncontrolled random intercept)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the model described </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mod4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id), <span class="at">data=</span>dat)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Peek at the results</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod4<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = mathach ~ 1 + (1 | id), data = dat)
coef.est  coef.se 
   12.64     0.24 

Error terms:
 Groups   Name        Std.Dev.
 id       (Intercept) 2.93    
 Residual             6.26    
---
number of obs: 7185, groups: id, 160
AIC = 47122.8, DIC = 47114.8
deviance = 47115.8 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the fixed effect coefficient (and it's standard error)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.2</span>) <span class="co"># extracts the fixed effect coefficient(s)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   12.63697 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">se.coef</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>fixef <span class="co">#extracts the standard errors for the fixed effect(s)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2443936</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the variance components</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: in the model display, we see the SDs, not the variance</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(mod4<span class="fl">.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name        Std.Dev.
 id       (Intercept) 2.9350  
 Residual             6.2569  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To get the variances, we extract each part and square it</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of random intercept</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sigma.hat</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   8.614025 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of level 1 residual (easier to extract)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod4<span class="fl">.2</span>)<span class="sc">^</span><span class="dv">2</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.14832</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># could also use the more complicated formula that we used with the intercept.</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If we do, we get the same thing</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma.hat</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>sigma<span class="sc">$</span>data<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.14832</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inference on the need for a random intercept</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Thus uses the book's way of calculating a test statistic with a</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># chi-squared distribution.</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">=</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>( id ) <span class="sc">%&gt;%</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>( <span class="at">nj =</span> <span class="fu">n</span>(),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">Y.bar.j =</span> <span class="fu">mean</span>( mathach ) )</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>gamma<span class="fl">.00</span> <span class="ot">=</span> <span class="fu">fixef</span>( mod4<span class="fl">.2</span> )[[<span class="dv">1</span>]]</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>sigma<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">sigma</span>(mod4<span class="fl">.2</span>)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>H <span class="ot">=</span> <span class="fu">sum</span>( schools<span class="sc">$</span>nj <span class="sc">*</span> (schools<span class="sc">$</span>Y.bar.j <span class="sc">-</span> gamma<span class="fl">.00</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> sigma<span class="fl">.2</span> )</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1660.232</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># our p-value</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>( H, <span class="at">df =</span> <span class="fu">nrow</span>( schools ) <span class="sc">-</span> <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.770612e-248</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculating the ICC</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>tau<span class="fl">.00</span> <span class="ot">=</span> <span class="fu">VarCorr</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>id[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>rho.hat <span class="ot">=</span> tau<span class="fl">.00</span> <span class="sc">/</span> (tau<span class="fl">.00</span> <span class="sc">+</span> sigma<span class="fl">.2</span> )</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>rho.hat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1803518</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating reliability for each school mean. (Here it is purely a function of</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># students in the school.  More students, more info, and thus more reliable.)</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>sigma<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">sigma</span>(mod4<span class="fl">.2</span>)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>tau<span class="fl">.00</span> <span class="ot">=</span> <span class="fu">VarCorr</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>id[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> tau<span class="fl">.00</span> <span class="sc">/</span> ( tau<span class="fl">.00</span> <span class="sc">+</span> sigma<span class="fl">.2</span> <span class="sc">/</span> schools<span class="sc">$</span>nj )</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>( lambda )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9013773</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A bonus graph of the reliabilities</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">qplot</span>( lambda )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hsb_ex_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="table-4.3-means-as-outcomes-model" class="level2" data-number="39.5">
<h2 data-number="39.5" class="anchored" data-anchor-id="table-4.3-means-as-outcomes-model"><span class="header-section-number">39.5</span> Table 4.3 Means as Outcomes Model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># (i.e. random intercept with Level 2 predictor)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the model described </span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>mod4<span class="fl">.3</span> <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> meanses <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>id), <span class="at">data=</span>dat)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Peek at the results</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod4<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = mathach ~ 1 + meanses + (1 | id), data = dat)
            coef.est coef.se
(Intercept) 12.65     0.15  
meanses      5.86     0.36  

Error terms:
 Groups   Name        Std.Dev.
 id       (Intercept) 1.62    
 Residual             6.26    
---
number of obs: 7185, groups: id, 160
AIC = 46969.3, DIC = 46956.9
deviance = 46959.1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the fixed effect coefficients (and standard errors/t-statistics)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.3</span>) <span class="co"># extracts the fixed effect coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)     meanses 
  12.649435    5.863538 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: you can call them separately by "indexing" them</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># just the intercept</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.3</span>)[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   12.64944 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># just coefficient on mean ses</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.3</span>)[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> meanses 
5.863538 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">se.coef</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>fixef <span class="co">#extracts the standard errors for the fixed effect(s)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1492801 0.3614580</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate (or extract) the t-ratio (aka the t-statistic)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: the author's don't present this for the intercept, because we often</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co"># don't care. But it is presented here for completeness</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># tstats for intercept</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.3</span>)[<span class="dv">1</span>]<span class="sc">/</span><span class="fu">se.coef</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>fixef[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   84.73622 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tstat mean ses</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(mod4<span class="fl">.3</span>)[<span class="dv">2</span>]<span class="sc">/</span><span class="fu">se.coef</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>fixef[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> meanses 
16.22191 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tstat extracted - this does both variables at once! </span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(<span class="fu">summary</span>(mod4<span class="fl">.3</span>))[,<span class="st">"t value"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)     meanses 
   84.73622    16.22191 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: Let's look at what is happening here:</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(<span class="fu">summary</span>(mod4<span class="fl">.3</span>)) <span class="co"># gives us all the fixed effect statistics we could want</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Estimate Std. Error       df  t value      Pr(&gt;|t|)
(Intercept) 12.649435  0.1492801 153.7425 84.73622 6.032590e-131
meanses      5.863538  0.3614580 153.4067 16.22191  4.267894e-35</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the [ ] is called "indexing" - it's a way of subsetting data by telling R</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co"># which [rows,columns] you want to see we are telling R that we want ALL rows "[</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ," but only the column labeled "t value"</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the variance components</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: in the model display, we see the SDs, not the variance</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(mod4<span class="fl">.3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name        Std.Dev.
 id       (Intercept) 1.6244  
 Residual             6.2576  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To get the variances, we extract each part and square it</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of random intercept</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sigma.hat</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   2.638708 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of level 1 residual</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod4<span class="fl">.3</span>)<span class="sc">^</span><span class="dv">2</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.15708</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Range of plausible values for school means for schools with mean SES of 0:</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co"># See page 73-74)</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>( mod4<span class="fl">.3</span> )[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> (<span class="fu">sigma.hat</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  9.465592 15.833279</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare to our model without mean ses</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>( mod4<span class="fl">.2</span> )[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span>) <span class="sc">*</span> (<span class="fu">sigma.hat</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  6.884441 18.389507</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Proportion reduction in variance or "variance explained" at level 2</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>tau.<span class="fl">00.</span>anova <span class="ot">=</span> (<span class="fu">sigma.hat</span>(mod4<span class="fl">.2</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>tau.<span class="fl">00.</span>meanses <span class="ot">=</span> (<span class="fu">sigma.hat</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>(tau.<span class="fl">00.</span>anova<span class="sc">-</span>tau.<span class="fl">00.</span>meanses) <span class="sc">/</span> tau.<span class="fl">00.</span>anova</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   0.693673 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Inference on the random effects</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">=</span> <span class="fu">merge</span>( schools, sch.dat, <span class="at">by=</span><span class="st">"id"</span> )</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>gamma<span class="fl">.00</span> <span class="ot">=</span> <span class="fu">fixef</span>( mod4<span class="fl">.3</span> )[[<span class="dv">1</span>]]</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>gamma<span class="fl">.01</span> <span class="ot">=</span> <span class="fu">fixef</span>( mod4<span class="fl">.3</span> )[[<span class="dv">2</span>]]</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">=</span> <span class="fu">mutate</span>( schools, <span class="at">resid =</span> Y.bar.j <span class="sc">-</span> gamma<span class="fl">.00</span> <span class="sc">-</span> gamma<span class="fl">.01</span><span class="sc">*</span>meanses )</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>H <span class="ot">=</span> <span class="fu">sum</span>( schools<span class="sc">$</span>nj <span class="sc">*</span> schools<span class="sc">$</span>resid<span class="sc">^</span><span class="dv">2</span> ) <span class="sc">/</span> <span class="fu">sigma</span>(mod4<span class="fl">.3</span>)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>H</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 633.5175</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pchisq</span>( H, <span class="fu">nrow</span>( schools ) <span class="sc">-</span> <span class="dv">2</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.617696e-58</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Reliability revisited (from pg 75)</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>mod4<span class="fl">.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerModLmerTest']
Formula: mathach ~ 1 + meanses + (1 | id)
   Data: dat
REML criterion at convergence: 46961.28
Random effects:
 Groups   Name        Std.Dev.
 id       (Intercept) 1.624   
 Residual             6.258   
Number of obs: 7185, groups:  id, 160
Fixed Effects:
(Intercept)      meanses  
     12.649        5.864  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>u.hat <span class="ot">=</span> <span class="fu">coef</span>( mod4<span class="fl">.3</span> )<span class="sc">$</span>id</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( u.hat )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     (Intercept)  meanses
1224    12.32688 5.863538
1288    12.71898 5.863538
1296    10.70101 5.863538
1308    12.92208 5.863538
1317    11.48086 5.863538
1358    11.73878 5.863538</code></pre>
</div>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>sigma<span class="fl">.2</span> <span class="ot">=</span> <span class="fu">sigma</span>(mod4<span class="fl">.3</span>)<span class="sc">^</span><span class="dv">2</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>tau<span class="fl">.00</span> <span class="ot">=</span> <span class="fu">VarCorr</span>(mod4<span class="fl">.3</span>)<span class="sc">$</span>id[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>sigma<span class="fl">.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.15708</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>tau<span class="fl">.00</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.638708</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the individual reliabilities---how well we can separate schools with the same Mean SES</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (So it is _conditional_ on the mean SES of the schools.)</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>lambda.j <span class="ot">=</span> tau<span class="fl">.00</span> <span class="sc">/</span> (tau<span class="fl">.00</span> <span class="sc">+</span> (sigma<span class="fl">.2</span> <span class="sc">/</span> schools<span class="sc">$</span>nj))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>( lambda.j )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7400747</code></pre>
</div>
</div>
</section>
<section id="table-4.4-random-coefficient-model-i.e.-random-slope" class="level2" data-number="39.6">
<h2 data-number="39.6" class="anchored" data-anchor-id="table-4.4-random-coefficient-model-i.e.-random-slope"><span class="header-section-number">39.6</span> Table 4.4 Random coefficient model (i.e.&nbsp;random slope)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># group-mean center ses  </span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>( id ) <span class="sc">%&gt;%</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">ses_grpcenter =</span> ses <span class="sc">-</span> <span class="fu">mean</span>(ses) )</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the model described </span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>mod4<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> ses_grpcenter <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">+</span> ses_grpcenter <span class="sc">|</span> id ), <span class="at">data=</span>dat)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Peek at the results</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod4<span class="fl">.4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = mathach ~ 1 + ses_grpcenter + (1 + ses_grpcenter | 
    id), data = dat)
              coef.est coef.se
(Intercept)   12.64     0.24  
ses_grpcenter  2.19     0.13  

Error terms:
 Groups   Name          Std.Dev. Corr 
 id       (Intercept)   2.95          
          ses_grpcenter 0.83     0.02 
 Residual               6.06          
---
number of obs: 7185, groups: id, 160
AIC = 46726.2, DIC = 46707.7
deviance = 46711.0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the fixed effect coefficients (and standard errors/t-statistics)</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(<span class="fu">summary</span>(mod4<span class="fl">.4</span>)) <span class="co">#this reproduces the whole first panel, though methods used above also work</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               Estimate Std. Error       df  t value      Pr(&gt;|t|)
(Intercept)   12.636193  0.2445047 156.7512 51.68077 2.286893e-100
ses_grpcenter  2.193196  0.1282589 155.2166 17.09976  1.582355e-37</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the variance components</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: in the model display, we see the SDs, not the variance</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">VarCorr</span>(mod4<span class="fl">.4</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Groups   Name          Std.Dev. Corr 
 id       (Intercept)   2.94636       
          ses_grpcenter 0.83307  0.019
 Residual               6.05807       </code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of random effects</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sigma.hat</span>(mod4<span class="fl">.4</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id)<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept) ses_grpcenter 
    8.6810437     0.6939974 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: to extract one or the other, you can use indexing</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sigma.hat</span>(mod4<span class="fl">.4</span>)<span class="sc">$</span>sigma<span class="sc">$</span>id[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span> <span class="co">#this is just the intercept random effect</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept) 
   8.681044 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of level 1 residual</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sigma</span>(mod4<span class="fl">.4</span>)<span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 36.70019</code></pre>
</div>
</div>
</section>
<section id="table-4.5-intercepts-and-slopes-as-outcomes-model" class="level2" data-number="39.7">
<h2 data-number="39.7" class="anchored" data-anchor-id="table-4.5-intercepts-and-slopes-as-outcomes-model"><span class="header-section-number">39.7</span> Table 4.5 Intercepts and Slopes as Outcomes Model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fit the model described </span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>mod4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> meanses <span class="sc">+</span> sector <span class="sc">+</span> ses_grpcenter<span class="sc">*</span>(meanses <span class="sc">+</span> sector) <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">+</span> ses_grpcenter <span class="sc">|</span> id ), <span class="at">data=</span>dat)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: The code above allows the coefficients to appear in the same order as in Table 4.5</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># R automatically includes the main effects, so this model can be written more</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="co"># concisely as shown below:</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># lmer(mathach ~ 1 + ses_grpcenter*(meanses + sector) + ( 1 + ses_grpcenter | id ), data=dat)</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Peek at the results</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(mod4<span class="fl">.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lmer(formula = mathach ~ 1 + meanses + sector + ses_grpcenter * 
    (meanses + sector) + (1 + ses_grpcenter | id), data = dat)
                      coef.est coef.se
(Intercept)           12.10     0.20  
meanses                5.33     0.37  
sector                 1.23     0.31  
ses_grpcenter          2.94     0.16  
meanses:ses_grpcenter  1.04     0.30  
sector:ses_grpcenter  -1.64     0.24  

Error terms:
 Groups   Name          Std.Dev. Corr 
 id       (Intercept)   1.54          
          ses_grpcenter 0.32     0.39 
 Residual               6.06          
---
number of obs: 7185, groups: id, 160
AIC = 46523.7, DIC = 46489.2
deviance = 46496.4 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract the fixed effect coefficients (and standard errors/t-statistics)</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co">#this reproduces the whole first panel, though methods used above also work</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(<span class="fu">summary</span>(mod4<span class="fl">.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       Estimate Std. Error       df   t value      Pr(&gt;|t|)
(Intercept)           12.095997  0.1987329 159.9143 60.865590 1.625101e-112
meanses                5.332898  0.3691567 150.9836 14.446161  2.944282e-30
sector                 1.226453  0.3062674 149.6139  4.004518  9.756638e-05
ses_grpcenter          2.938785  0.1550889 139.2934 18.949039  2.197507e-40
meanses:ses_grpcenter  1.038918  0.2988941 160.5428  3.475873  6.550388e-04
sector:ses_grpcenter  -1.642619  0.2397854 143.3351 -6.850371  2.009493e-10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: there is a slight descrepancy in the estimate for meanses:ses_grpcenter and </span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the t-statistics for meanses:ses_grpcenter and sector:ses_grpcenter; nothing that </span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="co"># changes the interpretations, however.</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Testing the need for sector  (see page 82)</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="co"># (We use a likelihood ratio test with the anova() function)</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>mod4.<span class="fl">5.</span>null <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> meanses <span class="sc">+</span> ses_grpcenter<span class="sc">*</span>(meanses) <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">+</span> ses_grpcenter <span class="sc">|</span> id ), <span class="at">data=</span>dat)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>( mod4<span class="fl">.5</span>, mod4.<span class="fl">5.</span>null )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: dat
Models:
mod4.5.null: mathach ~ 1 + meanses + ses_grpcenter * (meanses) + (1 + ses_grpcenter | id)
mod4.5: mathach ~ 1 + meanses + sector + ses_grpcenter * (meanses + sector) + (1 + ses_grpcenter | id)
            npar   AIC   BIC logLik deviance  Chisq Df Pr(&gt;Chisq)    
mod4.5.null    8 46568 46623 -23276    46552                         
mod4.5        10 46516 46585 -23248    46496 55.941  2  7.122e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Testing the need for random slope  (see page 84)</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (We use a likelihood ratio test with the anova() function)</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>mod4.<span class="fl">5.</span>null.slope <span class="ot">&lt;-</span> <span class="fu">lmer</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> meanses <span class="sc">+</span> sector <span class="sc">+</span> ses_grpcenter<span class="sc">*</span>(meanses <span class="sc">+</span> sector) <span class="sc">+</span> ( <span class="dv">1</span> <span class="sc">|</span> id ), <span class="at">data=</span>dat) </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>( mod4<span class="fl">.5</span>, mod4.<span class="fl">5.</span>null.slope )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data: dat
Models:
mod4.5.null.slope: mathach ~ 1 + meanses + sector + ses_grpcenter * (meanses + sector) + (1 | id)
mod4.5: mathach ~ 1 + meanses + sector + ses_grpcenter * (meanses + sector) + (1 + ses_grpcenter | id)
                  npar   AIC   BIC logLik deviance  Chisq Df Pr(&gt;Chisq)
mod4.5.null.slope    8 46513 46568 -23249    46497                     
mod4.5              10 46516 46585 -23248    46496 1.0039  2     0.6054</code></pre>
</div>
</div>
</section>
<section id="figure-4.1" class="level2" data-number="39.8">
<h2 data-number="39.8" class="anchored" data-anchor-id="figure-4.1"><span class="header-section-number">39.8</span> Figure 4.1</h2>
<p>NOTE: Figure 4.1 is a graphical display using the results from Model/Table 4.5</p>
<p>The solid line represents the slope of the gamma-01 coefficient; this is the same in public and catholic schools. The dotted lines represent the the slope for individual schools with â€œprototypicalâ€ values of meanses (-1,0,1 standard deviations from mean)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to calculate this, we should note a few values: </span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>avg_meanses <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>meanses) <span class="co">#average of mean ses var</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>high_meanses <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>meanses) <span class="sc">+</span> <span class="fu">sd</span>(dat<span class="sc">$</span>meanses) <span class="co"># 1 sd above avg meanses</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>low_meanses <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>meanses) <span class="sc">-</span> <span class="fu">sd</span>(dat<span class="sc">$</span>meanses) <span class="co"># 1 sd below avg meanses</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>fake.students <span class="ot">=</span> <span class="fu">expand.grid</span>( <span class="at">id =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">meanses =</span> <span class="fu">c</span>( low_meanses, avg_meanses, high_meanses ),</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sector =</span> <span class="fu">c</span>( <span class="dv">0</span>, <span class="dv">1</span> ),</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ses_grpcenter =</span> <span class="fu">c</span>( <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> ) )</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>fake.students <span class="ot">=</span> <span class="fu">mutate</span>( fake.students, <span class="at">ses =</span> meanses <span class="sc">+</span> ses_grpcenter )</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>fake.students<span class="sc">$</span>mathach <span class="ot">=</span> <span class="fu">predict</span>( mod4<span class="fl">.5</span>, <span class="at">newdata=</span>fake.students, <span class="at">allow.new.levels =</span> <span class="cn">TRUE</span> )</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>fake.schools <span class="ot">=</span> <span class="fu">filter</span>( fake.students, ses_grpcenter <span class="sc">==</span> <span class="dv">0</span> )</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>( fake.students, <span class="fu">aes</span>( ses, mathach ) ) <span class="sc">+</span> </span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> sector ) <span class="sc">+</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="fu">aes</span>( <span class="at">group=</span>meanses ), <span class="at">lty =</span> <span class="dv">2</span> ) <span class="sc">+</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>( <span class="at">data=</span>fake.schools, <span class="fu">aes</span>( <span class="at">x =</span> ses, <span class="at">y =</span> mathach ) ) <span class="sc">+</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>( <span class="at">data=</span>fake.schools, <span class="fu">aes</span>( <span class="at">x =</span> ses, <span class="at">y =</span> mathach ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hsb_ex_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="set-up-for-remaining-tablesfigures-of-chapter" class="level2" data-number="39.9">
<h2 data-number="39.9" class="anchored" data-anchor-id="set-up-for-remaining-tablesfigures-of-chapter"><span class="header-section-number">39.9</span> Set-up for remaining tables/figures of chapter</h2>
<p>In order to create table 4.6 and the following 2 graphs, we will need to prepare a new dataset. These next lines of code do that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Start with school level data frame and keep variables interesting to our model comparison</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>( sch.dat, id, meanses, sector )</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Add in number of observations per school </span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>n_j <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> <span class="fu">group_by</span>( id ) <span class="sc">%&gt;%</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n_j =</span> <span class="fu">n</span>())</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">&lt;-</span> <span class="fu">merge</span>(mod.comp, n_j, <span class="at">by=</span><span class="st">"id"</span>)</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( mod.comp )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id meanses sector n_j
1 1224  -0.428      0  47
2 1288   0.128      0  25
3 1296  -0.420      0  48
4 1308   0.534      1  20
5 1317   0.351      1  48
6 1358  -0.014      0  30</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Run site-specific OLS for each school and save estimates </span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate global (not group) centered ses</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>ses_centered <span class="ot">&lt;-</span> dat<span class="sc">$</span>ses <span class="sc">-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>ses)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the "for loop" method of generating an estimate for each of many small</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co"># worlds (schools). See lecture 2.3 code for the "tidyverse" way.</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>est.ols <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span><span class="dv">160</span>,<span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#create a matrix to store estimates </span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>se.ols <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow=</span><span class="dv">160</span>,<span class="at">ncol=</span><span class="dv">2</span>) <span class="co">#create matrix to store standard errors</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(dat<span class="sc">$</span>id))){ <span class="co">#looping across the 160 different values of id</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    id <span class="ot">&lt;-</span> <span class="fu">unique</span>(dat<span class="sc">$</span>id)[i] <span class="co">#pick the value of id we want</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">lm</span>(mathach <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> ses_grpcenter, <span class="at">data=</span>dat[dat<span class="sc">$</span>id<span class="sc">==</span>id,]) <span class="co">#run the model on students in that 1 school</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    est.ols[i,] <span class="ot">&lt;-</span> <span class="fu">coef</span>( mod ) <span class="co">#save the setimates in the matrix we created</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>    se.ols[i,] <span class="ot">&lt;-</span> <span class="fu">se.coef</span>( mod ) <span class="co"># and the SEs</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="co">#convert the matrix to a dataframe and attach the schoolid info</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>est.ols <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(est.ols)</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>est.ols<span class="sc">$</span>id <span class="ot">&lt;-</span> sch.dat<span class="sc">$</span>id</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(est.ols) <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">'b0_ols'</span>, <span class="st">'b1_ols'</span>, <span class="st">'id'</span> )</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a><span class="co">#store standard errors for later</span></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>se.ols <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(se.ols)</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>se.ols<span class="sc">$</span>id <span class="ot">&lt;-</span> sch.dat<span class="sc">$</span>id</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(se.ols) <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">'se_b0_ols'</span>, <span class="st">'se_b1_ols'</span>, <span class="st">'id'</span> )</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">&lt;-</span> <span class="fu">merge</span>(mod.comp, est.ols, <span class="at">by=</span><span class="st">'id'</span>)</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">&lt;-</span> <span class="fu">merge</span>(mod.comp, se.ols, <span class="at">by=</span><span class="st">'id'</span> )</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( mod.comp )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id meanses sector n_j    b0_ols    b1_ols se_b0_ols se_b1_ols
1 1224  -0.428      0  47  9.715447 2.5085817 1.0954478  1.765216
2 1288   0.128      0  25 13.510800 3.2554487 1.3637656  2.079675
3 1296  -0.420      0  48  7.635958 1.0759591 0.7740752  1.209016
4 1308   0.534      1  20 16.255500 0.1260242 1.4045813  3.003437
5 1317   0.351      1  48 13.177688 1.2739128 0.7902486  1.435942
6 1358  -0.014      0  30 11.206233 5.0680087 0.8994345  1.391550</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We are done running OLS on each of our schools and storing the results.</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract site-specific coefficients from "unconditional model" (model 4.4)</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod4<span class="fl">.4</span>)<span class="sc">$</span>id</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(est4<span class="fl">.4</span>) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'b0_uncond'</span>, <span class="st">'b1_uncond'</span>) <span class="co">#rename</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.4</span><span class="sc">$</span>id <span class="ot">=</span> <span class="fu">rownames</span>( est4<span class="fl">.4</span> )</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Extract site-specific coefficients from the "conditional model" (model 4.5)</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod4<span class="fl">.5</span>)<span class="sc">$</span>id</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( est4<span class="fl">.5</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     (Intercept)  meanses   sector ses_grpcenter meanses:ses_grpcenter
1224    12.02263 5.332898 1.226453      2.933689              1.038918
1288    12.55180 5.332898 1.226453      2.979174              1.038918
1296    10.38509 5.332898 1.226453      2.744066              1.038918
1308    12.12710 5.332898 1.226453      2.923822              1.038918
1317    10.56530 5.332898 1.226453      2.806582              1.038918
1358    11.60500 5.332898 1.226453      2.961265              1.038918
     sector:ses_grpcenter
1224            -1.642619
1288            -1.642619
1296            -1.642619
1308            -1.642619
1317            -1.642619
1358            -1.642619</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.5</span><span class="sc">$</span>id <span class="ot">=</span> <span class="fu">rownames</span>( est4<span class="fl">.5</span> )</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we need to calculate the point estimates using our individual regression equations</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="co"># including our level-2 values for each school</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="co"># (This is a bit of a pain.)</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.5</span> <span class="ot">=</span> <span class="fu">merge</span>( est4<span class="fl">.5</span>, mod.comp, <span class="at">by=</span><span class="st">"id"</span>, <span class="at">suffixes =</span> <span class="fu">c</span>( <span class="st">""</span>, <span class="st">".v"</span> ) )</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( est4<span class="fl">.5</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id (Intercept)  meanses   sector ses_grpcenter meanses:ses_grpcenter
1 1224    12.02263 5.332898 1.226453      2.933689              1.038918
2 1288    12.55180 5.332898 1.226453      2.979174              1.038918
3 1296    10.38509 5.332898 1.226453      2.744066              1.038918
4 1308    12.12710 5.332898 1.226453      2.923822              1.038918
5 1317    10.56530 5.332898 1.226453      2.806582              1.038918
6 1358    11.60500 5.332898 1.226453      2.961265              1.038918
  sector:ses_grpcenter meanses.v sector.v n_j    b0_ols    b1_ols se_b0_ols
1            -1.642619    -0.428        0  47  9.715447 2.5085817 1.0954478
2            -1.642619     0.128        0  25 13.510800 3.2554487 1.3637656
3            -1.642619    -0.420        0  48  7.635958 1.0759591 0.7740752
4            -1.642619     0.534        1  20 16.255500 0.1260242 1.4045813
5            -1.642619     0.351        1  48 13.177688 1.2739128 0.7902486
6            -1.642619    -0.014        0  30 11.206233 5.0680087 0.8994345
  se_b1_ols
1  1.765216
2  2.079675
3  1.209016
4  3.003437
5  1.435942
6  1.391550</code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.5</span> <span class="ot">=</span> <span class="fu">mutate</span>( est4<span class="fl">.5</span>, </span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">b0_cond =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="sc">+</span> sector <span class="sc">*</span> sector.v <span class="sc">+</span> meanses <span class="sc">*</span> meanses.v,</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">b1_cond =</span> ses_grpcenter <span class="sc">+</span> <span class="st">`</span><span class="at">sector:ses_grpcenter</span><span class="st">`</span> <span class="sc">*</span> sector.v <span class="sc">+</span> <span class="st">`</span><span class="at">meanses:ses_grpcenter</span><span class="st">`</span> <span class="sc">*</span> meanses.v )</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.5</span> <span class="ot">=</span> dplyr<span class="sc">::</span><span class="fu">select</span>( est4<span class="fl">.5</span>, id, b0_cond, b1_cond )</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Combine the MLM estimates into 1 dataset with ids</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>est.mlm <span class="ot">&lt;-</span> <span class="fu">merge</span>( est4<span class="fl">.4</span>, est4<span class="fl">.5</span>, <span class="at">by=</span><span class="st">"id"</span> )</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all the estimates together by school id</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">&lt;-</span> <span class="fu">merge</span>(mod.comp,est.mlm,<span class="at">by =</span> <span class="st">'id'</span>,<span class="at">all=</span><span class="cn">TRUE</span>)</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( mod.comp )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id meanses sector n_j    b0_ols    b1_ols se_b0_ols se_b1_ols b0_uncond
1 1224  -0.428      0  47  9.715447 2.5085817 1.0954478  1.765216  9.956953
2 1288   0.128      0  25 13.510800 3.2554487 1.3637656  2.079675 13.386036
3 1296  -0.420      0  48  7.635958 1.0759591 0.7740752  1.209016  8.039091
4 1308   0.534      1  20 16.255500 0.1260242 1.4045813  3.003437 15.622073
5 1317   0.351      1  48 13.177688 1.2739128 0.7902486  1.435942 13.132771
6 1358  -0.014      0  30 11.206233 5.0680087 0.8994345  1.391550 11.387452
  b1_uncond   b0_cond  b1_cond
1  2.262837  9.740146 2.489033
2  2.375964 13.234409 3.112156
3  1.872247  8.145275 2.307720
4  2.050193 16.201317 1.835985
5  1.997129 13.663596 1.528623
6  2.738390 11.530341 2.946721</code></pre>
</div>
</div>
</section>
<section id="table-4.6-comparing-site-specific-estimates-from-different-models" class="level2" data-number="39.10">
<h2 data-number="39.10" class="anchored" data-anchor-id="table-4.6-comparing-site-specific-estimates-from-different-models"><span class="header-section-number">39.10</span> Table 4.6 Comparing site-specific estimates from different models</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Create the list of rows that B&amp;R include in the table p. 87</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>keeprows <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">15</span>, <span class="dv">17</span>, <span class="dv">22</span>, <span class="dv">27</span>, <span class="dv">53</span>, <span class="dv">69</span>, <span class="dv">75</span>, <span class="dv">81</span>, <span class="dv">90</span>, <span class="dv">135</span>, <span class="dv">153</span>)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Limit data to the rows of interest, and print the columns in Table 4.6 in the correct order</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>tab4<span class="fl">.6</span> <span class="ot">&lt;-</span> mod.comp[keeprows, <span class="fu">c</span>(<span class="st">'b0_ols'</span>,<span class="st">'b1_ols'</span>,<span class="st">'b0_uncond'</span>,<span class="st">'b1_uncond'</span>,<span class="st">'b0_cond'</span>,<span class="st">'b1_cond'</span>,<span class="st">'n_j'</span>,<span class="st">'meanses'</span>,<span class="st">'sector'</span>) ]</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Print Table 4.6 -- the Empirical Bayes from conditional model (b0_cond, b1_cond) are waaaaaay off</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(tab4<span class="fl">.6</span>,<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    b0_ols b1_ols b0_uncond b1_uncond b0_cond b1_cond n_j meanses sector
4    16.26   0.13     15.62      2.05   16.20    1.84  20    0.53      1
15   15.98   2.15     15.74      2.19   16.01    1.84  53    0.52      1
17   18.11   0.09     17.41      1.95   17.25    3.71  29    0.69      0
22   11.14  -0.78     11.22      1.15   10.89    0.63  67   -0.62      1
27   13.40   4.10     13.32      2.54   12.95    3.00  38   -0.06      0
53    9.52   3.74      9.76      2.75    9.37    2.42  51   -0.64      0
69   11.47   6.18     11.64      2.72   11.92    3.03  25    0.08      0
75    9.06   1.65      9.28      2.01    9.30    0.67  63   -0.59      1
81   15.42   5.26     15.25      3.14   15.53    1.91  66    0.43      1
90   12.14   1.97     12.18      2.14   12.34    3.03  50    0.19      0
135   4.55   0.25      6.42      1.92    8.55    2.63  14    0.03      0
153  10.28   0.76     10.71      2.06    9.67    2.37  19   -0.59      0</code></pre>
</div>
</div>
</section>
<section id="figure-4.2-scatter-plots-of-the-estimates-from-2-unconstrained-models" class="level2" data-number="39.11">
<h2 data-number="39.11" class="anchored" data-anchor-id="figure-4.2-scatter-plots-of-the-estimates-from-2-unconstrained-models"><span class="header-section-number">39.11</span> Figure 4.2 : Scatter plots of the estimates from 2 unconstrained models</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel (a) and Panel (b) are plotted on the same graph </span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>mod.comp,<span class="fu">aes</span>()) <span class="sc">+</span> </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>b1_ols,<span class="at">y=</span>b0_ols),<span class="at">color=</span><span class="st">'black'</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>b1_uncond,<span class="at">y=</span>b0_uncond),<span class="at">color=</span><span class="st">'blue'</span>,<span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Black=OLS; Blue=Unconditional EB"</span>) <span class="sc">+</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">8</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">2</span>,<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hsb_ex_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="figure-4.3-scatter-plots-of-residuals-from-the-ols-constrained-mlm-model" class="level2" data-number="39.12">
<h2 data-number="39.12" class="anchored" data-anchor-id="figure-4.3-scatter-plots-of-residuals-from-the-ols-constrained-mlm-model"><span class="header-section-number">39.12</span> Figure 4.3 : Scatter plots of residuals from the OLS &amp; Constrained MLM model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Luke: Equation 4.271 and 4.27b (p. 92) are allegedly how we calculate the intercept and slope residuals </span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="do">## But I'm not sure where the estimates for the gamma-hat terms come from; the OLS model only includes</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="do">## individual-level ses</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># trying it here with the predictions from conditional EB</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>fes <span class="ot">=</span> <span class="fu">fixef</span>( mod4<span class="fl">.5</span> )</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>fes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          (Intercept)               meanses                sector 
            12.095997              5.332898              1.226453 
        ses_grpcenter meanses:ses_grpcenter  sector:ses_grpcenter 
             2.938785              1.038918             -1.642619 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">=</span> <span class="fu">mutate</span>( mod.comp,</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">u0_ols =</span> b0_ols <span class="sc">-</span> (fes[<span class="dv">1</span>] <span class="sc">+</span> fes[<span class="dv">2</span>]<span class="sc">*</span>meanses <span class="sc">+</span> fes[<span class="dv">3</span>]<span class="sc">*</span>sector),</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">u1_ols =</span> b1_ols <span class="sc">-</span> (fes[<span class="dv">4</span>] <span class="sc">+</span> fes[<span class="dv">5</span>]<span class="sc">*</span>meanses <span class="sc">+</span> fes[<span class="dv">6</span>]<span class="sc">*</span>sector)  )</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Panel (a) and (b) plotted on same graph</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>mod.comp <span class="ot">=</span> <span class="fu">mutate</span>( mod.comp, </span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">u0_cond =</span> b0_cond <span class="sc">-</span> (fes[<span class="dv">1</span>] <span class="sc">+</span> fes[<span class="dv">2</span>]<span class="sc">*</span>meanses <span class="sc">+</span> fes[<span class="dv">3</span>]<span class="sc">*</span>sector),</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">u1_cond =</span> b1_cond <span class="sc">-</span> (fes[<span class="dv">4</span>] <span class="sc">+</span> fes[<span class="dv">5</span>]<span class="sc">*</span>meanses <span class="sc">+</span> fes[<span class="dv">6</span>]<span class="sc">*</span>sector)  )</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( mod.comp )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    id meanses sector n_j    b0_ols    b1_ols se_b0_ols se_b1_ols b0_uncond
1 1224  -0.428      0  47  9.715447 2.5085817 1.0954478  1.765216  9.956953
2 1288   0.128      0  25 13.510800 3.2554487 1.3637656  2.079675 13.386036
3 1296  -0.420      0  48  7.635958 1.0759591 0.7740752  1.209016  8.039091
4 1308   0.534      1  20 16.255500 0.1260242 1.4045813  3.003437 15.622073
5 1317   0.351      1  48 13.177688 1.2739128 0.7902486  1.435942 13.132771
6 1358  -0.014      0  30 11.206233 5.0680087 0.8994345  1.391550 11.387452
  b1_uncond   b0_cond  b1_cond      u0_ols      u1_ols     u0_cond      u1_cond
1  2.262837  9.740146 2.489033 -0.09807014  0.01445354 -0.07337107 -0.005095579
2  2.375964 13.234409 3.112156  0.73219201  0.18368221  0.45580075  0.040389349
3  1.872247  8.145275 2.307720 -2.22022179 -1.42648036 -1.71090544 -0.194719195
4  2.050193 16.201317 1.835985  0.08528223 -1.72492410  0.03109939 -0.014963432
5  1.997129 13.663596 1.528623 -2.01661001 -0.38691354 -1.53070178 -0.132203129
6  2.738390 11.530341 2.946721 -0.81510320  2.14376861 -0.49099553  0.022480378</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>( mod.comp )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 160</code></pre>
</div>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>mod.comp, <span class="fu">aes</span>( <span class="at">pch=</span><span class="fu">as.factor</span>(sector)) ) <span class="sc">+</span> </span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>u1_ols, <span class="at">y=</span>u0_ols),<span class="at">color=</span><span class="st">'black'</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span>   </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>u1_cond, <span class="at">y=</span>u0_cond),<span class="at">color=</span><span class="st">'blue'</span>, <span class="at">alpha=</span><span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Black: OLS, Blue: Conditional EB"</span>) <span class="sc">+</span> </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">xlim</span>(<span class="sc">-</span><span class="dv">6</span>,<span class="dv">6</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">8</span>,<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hsb_ex_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To get in two-panel format we need to get our data to long format</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>mod.comp.ols <span class="ot">=</span> <span class="fu">data.frame</span>( <span class="at">sector =</span> mod.comp<span class="sc">$</span>sector,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">u0 =</span> mod.comp<span class="sc">$</span>u0_ols,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">u1 =</span> mod.comp<span class="sc">$</span>u1_ols )</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>mod.comp.EB <span class="ot">=</span> <span class="fu">data.frame</span>(  <span class="at">sector =</span> mod.comp<span class="sc">$</span>sector,</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">u0 =</span> mod.comp<span class="sc">$</span>u0_cond,</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">u1 =</span> mod.comp<span class="sc">$</span>u1_cond )</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>mod.comp.l <span class="ot">=</span> <span class="fu">bind_rows</span>( <span class="at">ols=</span>mod.comp.ols, <span class="at">cond =</span> mod.comp.EB, <span class="at">.id =</span> <span class="st">"method"</span> )</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>mod.comp.l, <span class="fu">aes</span>( u1, u0, <span class="at">pch=</span><span class="fu">as.factor</span>(sector)) ) <span class="sc">+</span> </span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> method ) <span class="sc">+</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hsb_ex_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="table-4.7-pg-94" class="level2" data-number="39.13">
<h2 data-number="39.13" class="anchored" data-anchor-id="table-4.7-pg-94"><span class="header-section-number">39.13</span> Table 4.7 : pg 94</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This section is not very good--I would skip.</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generating confidence intervals for individual random intercepts and slopes is a weird business.</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># OLS First:</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Doing it by fitting OLS on our subset</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>sch<span class="fl">.2305</span> <span class="ot">=</span> <span class="fu">filter</span>( dat, id <span class="sc">==</span> <span class="dv">2305</span> )</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( sch<span class="fl">.2305</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 Ã— 13
# Groups:   id [1]
  id    minority female    ses mathach  size sector pracad disclim himinty
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 2305         1      1 -0.738   16.4    485      1   0.69   -1.38       1
2 2305         1      1 -1.18    12.8    485      1   0.69   -1.38       1
3 2305         1      1 -0.308   15.3    485      1   0.69   -1.38       1
4 2305         1      1 -0.358   12.7    485      1   0.69   -1.38       1
5 2305         1      1 -1.52    10.2    485      1   0.69   -1.38       1
6 2305         1      1 -0.518    8.94   485      1   0.69   -1.38       1
# â„¹ 3 more variables: meanses &lt;dbl&gt;, ses_grpcenter &lt;dbl&gt;, ses_centered &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>M<span class="fl">.2305</span> <span class="ot">=</span> <span class="fu">lm</span>( mathach <span class="sc">~</span> ses_grpcenter, <span class="at">data=</span>sch<span class="fl">.2305</span> )</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>M<span class="fl">.2305</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = mathach ~ ses_grpcenter, data = sch.2305)

Coefficients:
  (Intercept)  ses_grpcenter  
      11.1378        -0.7821  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>( M<span class="fl">.2305</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  2.5 %    97.5 %
(Intercept)    9.911824 12.363698
ses_grpcenter -2.665989  1.101767</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>sch<span class="fl">.8367</span> <span class="ot">=</span> <span class="fu">filter</span>( dat, id <span class="sc">==</span> <span class="dv">8367</span> )</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( sch<span class="fl">.8367</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 Ã— 13
# Groups:   id [1]
  id    minority female    ses mathach  size sector pracad disclim himinty
  &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 8367         0      0 -0.228  15.9     153      0      0    1.79       0
2 8367         0      1 -0.208   1.86    153      0      0    1.79       0
3 8367         1      0  0.532  -2.83    153      0      0    1.79       0
4 8367         0      1  0.662   2.12    153      0      0    1.79       0
5 8367         0      0 -0.228   6.76    153      0      0    1.79       0
6 8367         0      0 -1.08    0.725   153      0      0    1.79       0
# â„¹ 3 more variables: meanses &lt;dbl&gt;, ses_grpcenter &lt;dbl&gt;, ses_centered &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>M<span class="fl">.8367</span> <span class="ot">=</span> <span class="fu">lm</span>( mathach <span class="sc">~</span> ses_grpcenter, <span class="at">data=</span>sch<span class="fl">.8367</span> )</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>M<span class="fl">.8367</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = mathach ~ ses_grpcenter, data = sch.8367)

Coefficients:
  (Intercept)  ses_grpcenter  
       4.5528         0.2504  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">confint</span>( M<span class="fl">.8367</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  2.5 %   97.5 %
(Intercept)    1.872974 7.232598
ses_grpcenter -3.431096 3.931845</code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use SE from earlier to get confint</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.7</span> <span class="ot">&lt;-</span> mod.comp[<span class="fu">c</span>(<span class="dv">22</span>,<span class="dv">135</span>),]</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id meanses sector n_j    b0_ols     b1_ols se_b0_ols se_b1_ols b0_uncond
22  2305  -0.622      1  67 11.137761 -0.7821112 0.6138468  0.943289 11.222551
135 8367   0.032      0  14  4.552786  0.2503748 1.2299413  1.689668  6.423938
    b1_uncond   b0_cond   b1_cond    u0_ols    u1_ols    u0_cond     u1_cond
22   1.149555 10.886600 0.6276417  1.132373 -1.432070  0.8812116 -0.02231763
135  1.924903  8.549007 2.6307047 -7.713864 -2.721656 -3.7176433 -0.34132569</code></pre>
</div>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CI for intercept and slope using our normal and stored SEs.</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (Not taking t distribution into account changes things, as does not</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="co"># taking the uncertainty in the fixed effects for the EB CIs.  So this is</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co"># very approximate.)</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>se_uncond <span class="ot">=</span> <span class="fu">as.data.frame</span>( <span class="fu">se.coef</span>(mod4<span class="fl">.4</span>)<span class="sc">$</span>id )</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( se_uncond )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     (Intercept) ses_grpcenter
1224   0.8464092     0.7189592
1288   1.1205609     0.7593421
1296   0.8382669     0.7111100
1308   1.2307722     0.8005012
1317   0.8382675     0.7377054
1358   1.0354852     0.7489241</code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>( se_uncond ) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"se_b0_uncond"</span>,<span class="st">"se_b1_uncond"</span> )</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>se_cond <span class="ot">=</span> <span class="fu">as.data.frame</span>( <span class="fu">se.coef</span>(  mod4<span class="fl">.5</span> )<span class="sc">$</span>id )</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>( se_cond ) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"se_b0_cond"</span>,<span class="st">"se_b1_cond"</span> )</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>( se_cond )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     se_b0_cond se_b1_cond
1224  0.7662313  0.2929654
1288  0.9521965  0.2988437
1296  0.7601221  0.2923332
1308  1.0176181  0.3025414
1317  0.7603073  0.2940970
1358  0.8982481  0.2971694</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>se_uncond<span class="sc">$</span>id <span class="ot">=</span> <span class="fu">rownames</span>( se_uncond )</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>se_cond<span class="sc">$</span>id <span class="ot">=</span> <span class="fu">rownames</span>( se_cond )</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.7</span> <span class="ot">=</span> <span class="fu">merge</span>( est4<span class="fl">.7</span>, se_uncond, <span class="at">by=</span><span class="st">"id"</span> )</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>est4<span class="fl">.7</span> <span class="ot">=</span> <span class="fu">merge</span>( est4<span class="fl">.7</span>, se_cond, <span class="at">by=</span><span class="st">"id"</span> )</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>est4.<span class="fl">7.</span>int <span class="ot">=</span> <span class="fu">mutate</span>( est4<span class="fl">.7</span>, </span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.low.ols =</span> b0_ols <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_ols,</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.high.ols =</span> b0_ols <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_ols,</span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.low.uncond =</span> b0_uncond <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_uncond,</span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.high.uncond =</span> b0_uncond <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_uncond,</span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.low.cond =</span> b0_cond <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_cond,</span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CI.high.cond =</span> b0_cond <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b0_cond )</span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>( est4.<span class="fl">7.</span>int, <span class="fu">starts_with</span>(<span class="st">"CI"</span> ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  CI.low.ols CI.high.ols CI.low.uncond CI.high.uncond CI.low.cond CI.high.cond
1   9.934621   12.340901      9.815648      12.629455    9.579800     12.19340
2   2.142101    6.963471      3.642797       9.205078    6.361492     10.73652</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>est4.<span class="fl">7.</span>slope <span class="ot">=</span> <span class="fu">mutate</span>( est4<span class="fl">.7</span>, </span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.low.ols =</span> b1_ols <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_ols,</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.high.ols =</span> b1_ols <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_ols,</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.low.uncond =</span> b1_uncond <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_uncond,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.high.uncond =</span> b1_uncond <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_uncond,</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.low.cond =</span> b1_cond <span class="sc">+</span> <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_cond,</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">CI.high.cond =</span> b1_cond <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se_b1_cond )</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>( est4.<span class="fl">7.</span>slope, <span class="fu">starts_with</span>(<span class="st">"CI"</span> ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  CI.low.ols CI.high.ols CI.low.uncond CI.high.uncond CI.low.cond CI.high.cond
1  -2.630958    1.066735    -0.1675367       2.466647   0.0629627     1.192321
2  -3.061375    3.562124     0.3960110       3.453795   2.0356645     3.225745</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./robust_mlm.html" class="pagination-link" aria-label="MLM and Cluster-Robust Standard Errors">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">MLM and Cluster-Robust Standard Errors</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./faraway_ex.html" class="pagination-link" aria-label="Code for Faraway Example">
        <span class="nav-page-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Code for Faraway Example</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>